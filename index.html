<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í˜‘ë™ì¡°í•© ERP (ë©”ì¸)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
    .main-card { width: 100%; max-width: 400px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
    .btn-menu { text-align: left; padding: 15px; margin-bottom: 10px; transition: transform 0.2s; border: 1px solid #eee; }
    .btn-menu:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); background-color: #f8f9fa; }
    .hidden { display: none !important; }
    .profile-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
  </style>
</head>
<body>

  <div class="main-card">
    <h3 class="fw-bold mb-4">âš¡ í˜‘ë™ì¡°í•© ERP</h3>

    <div id="loadingScreen">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <p class="text-muted small">ì ‘ì† ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
    
    <div id="loginForm" class="hidden">
      <p class="text-muted mb-4 small">
        ë“±ë¡ëœ ì´ë©”ì¼ë¡œ ê°„í¸í•˜ê²Œ ë¡œê·¸ì¸í•˜ì„¸ìš”.<br>
        (ë§í¬ í´ë¦­ ì‹œ ìë™ ì ‘ì†)
      </p>

      <div class="mb-3 text-start">
        <label class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
        <input type="email" class="form-control" id="emailInput" placeholder="name@coop.com">
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSend" onclick="sendMagicLink()">
        ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°
      </button>
      
      <div id="statusMsg" class="mt-3 text-success small" style="display:none;"></div>
    </div>

    <div id="menuArea" class="hidden">
      <div class="profile-box">
        <h5 class="fw-bold mb-1" id="userName">í™ê¸¸ë™ ë‹˜</h5>
        <span class="badge bg-primary" id="userTeam">ê¸°íšíŒ€</span>
        <span class="text-muted small ms-1" id="userRank">ê³¼ì¥</span>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-white btn-menu" onclick="location.href='approval.html'">
          ğŸ“ <strong>ì „ìê²°ì¬</strong>
          <span class="d-block small text-muted">ê¸°ì•ˆ ì‘ì„± ë° ê²°ì¬ ì²˜ë¦¬</span>
        </button>

        <button class="btn btn-white btn-menu" onclick="location.href='mypage.html'">
          ğŸ‘¤ <strong>ë§ˆì´í˜ì´ì§€</strong>
          <span class="d-block small text-muted">ë‚´ ì •ë³´ ë° íœ´ê°€ ê´€ë¦¬</span>
        </button>
        
        <button class="btn btn-white btn-menu hidden" id="btnAccounting" onclick="location.href='accounting.html'">
          ğŸ“’ <strong>íšŒê³„ê´€ë¦¬</strong>
          <span class="d-block small text-muted">ì§€ì¶œ ë° ì˜ˆì‚° ê´€ë¦¬</span>
        </button>
        
        <button class="btn btn-white btn-menu hidden" id="btnAdmin" onclick="location.href='admin_employee.html'">
          âš™ï¸ <strong>ì§ì›ê´€ë¦¬</strong>
          <span class="d-block small text-muted">ì¸ì‚¬ ë° ê¸‰ì—¬ ì„¤ì •</span>
        </button>
      </div>

      <button class="btn btn-link text-secondary btn-sm mt-4" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

<script>
// ============================================================
// [ì„¤ì •] ìˆ˜í¼ë² ì´ìŠ¤ ì—°ê²°
// ============================================================
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';

// ë³€ìˆ˜ëª… ì¶©ëŒ ë°©ì§€ (_supabase)
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// â˜… ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì´ í˜ì´ì§€(index.html)ë¡œ ëŒì•„ì˜¤ê²Œ ì„¤ì •
const REDIRECT_URL = 'https://minho-kim.github.io/yonginsolar_erp/index.html'; 

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.onload = async function() {
    // 1. í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    const { data: { session } } = await _supabase.auth.getSession();

    if (session) {
        // 2. ë¡œê·¸ì¸ ë˜ì–´ ìˆìœ¼ë©´ -> ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì™€ì„œ ë©”ë‰´ ë³´ì—¬ì£¼ê¸°
        await loadUserInfo(session.user.email);
    } else {
        // 3. ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ -> ë¡œê·¸ì¸ í¼ ë³´ì—¬ì£¼ê¸°
        showScreen('loginForm');
    }
};

// ì‚¬ìš©ì ì •ë³´ ë° ê¶Œí•œ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadUserInfo(email) {
    const { data, error } = await _supabase
        .from('ref_employees')
        .select('*')
        .eq('email', email)
        .single(); // í•œ ëª…ë§Œ ê²€ìƒ‰

    if (error || !data) {
        alert("ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        _supabase.auth.signOut();
        showScreen('loginForm');
        return;
    }

    // ì •ë³´ë¥¼ ë¸Œë¼ìš°ì €ì— ì €ì¥ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œë„ ì“°ê²Œ)
    localStorage.setItem('erp_user', JSON.stringify(data));

    // í™”ë©´ì— ì´ë¦„/ì§ê¸‰ í‘œì‹œ
    document.getElementById('userName').innerText = data.emp_name + " ë‹˜";
    document.getElementById('userTeam').innerText = data.department || "ì†Œì†ì—†ìŒ";
    document.getElementById('userRank').innerText = data.position || "";

    // ê¶Œí•œë³„ ë²„íŠ¼ í‘œì‹œ (access_level ë˜ëŠ” role ì»¬ëŸ¼ ì‚¬ìš© ê°€ì •)
    // ì˜ˆ: access_levelì´ 'ê´€ë¦¬ì' ì´ê±°ë‚˜ 1ë“±ê¸‰ì´ë©´ ë³´ì„
    // êµ­ì¥ë‹˜ DBì— ë§ì¶° ì¡°ê±´ ìˆ˜ì • ê°€ëŠ¥
    if (data.role === 'admin' || data.role === 'manager' || data.position === 'êµ­ì¥' || data.position === 'ì´ì‚¬') {
        document.getElementById('btnAccounting').classList.remove('hidden');
    }
    if (data.role === 'admin' || data.position === 'êµ­ì¥') {
        document.getElementById('btnAdmin').classList.remove('hidden');
    }

    showScreen('menuArea');
}

// í™”ë©´ ì „í™˜ í•¨ìˆ˜
function showScreen(id) {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('menuArea').classList.add('hidden');
    
    document.getElementById(id).classList.remove('hidden');
}

// ë§¤ì§ ë§í¬ ë°œì†¡
async function sendMagicLink() {
    const email = document.getElementById('emailInput').value;
    const btn = document.getElementById('btnSend');
    const msg = document.getElementById('statusMsg');

    if (!email) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";

    const { error } = await _supabase.auth.signInWithOtp({
        email: email,
        options: { emailRedirectTo: REDIRECT_URL }
    });

    if (error) {
        alert("ì „ì†¡ ì‹¤íŒ¨: " + error.message);
        btn.disabled = false; btn.innerText = "ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°";
    } else {
        btn.classList.add("hidden");
        msg.style.display = "block";
        msg.innerHTML = `<strong>ğŸ“© ì „ì†¡ ì™„ë£Œ!</strong><br>ë©”ì¼í•¨ì˜ ë§í¬ë¥¼ í´ë¦­í•˜ë©´<br>ìë™ìœ¼ë¡œ ì´ ë©”ë‰´ í™”ë©´ìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.`;
    }
}

// ë¡œê·¸ì•„ì›ƒ
async function logout() {
    if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        await _supabase.auth.signOut();
        localStorage.removeItem('erp_user');
        location.reload();
    }
}
</script>
  <div class="text-center mt-4 mb-3">
  <small class="text-muted" style="cursor: pointer; text-decoration: underline;" onclick="openPatchModal()">
    Ver <span id="currentVersion">Loading...</span> (Release Notes)
  </small>
</div>

<div class="modal fade" id="patchNoteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">ğŸš€ ì—…ë°ì´íŠ¸ íˆìŠ¤í† ë¦¬</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div id="patchList" class="list-group list-group-flush">
            </div>
      </div>
      <div class="modal-footer bg-light">
        <small class="text-muted me-auto">ì§€ì†ì ìœ¼ë¡œ ë°œì „í•˜ëŠ” ì‹œìŠ¤í…œì´ ë˜ê² ìŠµë‹ˆë‹¤.</small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
// ê¸°ì¡´ supabase ì„¤ì • ì•„ë˜ì— ì¶”ê°€í•˜ì„¸ìš”

// 1. ìµœì‹  ë²„ì „ ì¡°íšŒ ë° í‘œì‹œ
async function loadCurrentVersion() {
    const { data } = await _supabase
        .from('sys_patch_notes')
        .select('version')
        .order('release_date', { ascending: false })
        .order('id', { ascending: false }) // ê°™ì€ ë‚ ì§œë©´ ID ì—­ìˆœ
        .limit(1)
        .single();
        
    if(data) {
        document.getElementById("currentVersion").innerText = data.version;
    }
}

// 2. íŒ¨ì¹˜ë…¸íŠ¸ ëª¨ë‹¬ ì—´ê¸°
async function openPatchModal() {
    const modal = new bootstrap.Modal(document.getElementById('patchNoteModal'));
    const listEl = document.getElementById("patchList");
    
    listEl.innerHTML = '<div class="p-4 text-center"><div class="spinner-border text-primary"></div></div>';
    modal.show();
    
    const { data } = await _supabase
        .from('sys_patch_notes')
        .select('*')
        .order('release_date', { ascending: false })
        .order('id', { ascending: false });
        
    if(!data || data.length === 0) {
        listEl.innerHTML = '<div class="p-4 text-center text-muted">ì—…ë°ì´íŠ¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ìµœì‹ ìˆœ)
    listEl.innerHTML = data.map(note => {
        // ì¤„ë°”ê¿ˆ ë¬¸ì(\n)ë¥¼ <br>ë¡œ ë³€í™˜
        const contentHtml = note.content.replace(/\n/g, '<br>');
        const badge = note.is_major 
            ? '<span class="badge bg-danger ms-2">Major Update</span>' 
            : '<span class="badge bg-secondary ms-2">Patch</span>';
            
        return `
            <div class="list-group-item p-3">
                <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 fw-bold text-primary">v${note.version} ${badge}</h6>
                    <small class="text-muted">${note.release_date}</small>
                </div>
                <h6 class="fw-bold mb-2">${note.title}</h6>
                <p class="mb-1 small text-secondary" style="line-height: 1.5;">${contentHtml}</p>
            </div>
        `;
    }).join("");
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„ì „ í™•ì¸ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", function() {
    loadCurrentVersion();
});
</script>
</body>
</html>
