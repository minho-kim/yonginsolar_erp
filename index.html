<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í˜‘ë™ì¡°í•© ERP (GitHub Ver)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .login-card { width: 100%; max-width: 400px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
    .btn-menu { width: 100%; padding: 15px; margin-bottom: 10px; font-weight: bold; text-align: left; transition: all 0.2s; }
    .btn-menu:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loadingScreen">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-muted">ìˆ˜í¼ë² ì´ìŠ¤ ì ‘ì† ì¤‘...</p>
  </div>

  <div class="login-card hidden" id="mainCard">
    <h3 class="fw-bold mb-4">âš¡ í˜‘ë™ì¡°í•© ERP</h3>
    
    <div id="loginForm" class="hidden">
      <div class="alert alert-light border small text-start">
        GitHub ë²„ì „ ì ‘ì†ì…ë‹ˆë‹¤.<br>
        <strong>ì´ë¦„ê³¼ PIN ë²ˆí˜¸</strong>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
      </div>
      <div class="mb-3 text-start">
        <label class="form-label">ì´ë¦„ ì„ íƒ</label>
        <select class="form-select" id="loginNameSelect">
            <option value="">ë¡œë”© ì¤‘...</option>
        </select>
      </div>
      <div class="mb-3 text-start">
        <label class="form-label">PIN ë²ˆí˜¸</label>
        <input type="password" class="form-control" id="loginPin" placeholder="PIN ì…ë ¥" maxlength="4">
      </div>
      <button class="btn btn-primary w-100" onclick="handleLogin()">ë¡œê·¸ì¸</button>
    </div>

    <div id="menuArea" class="hidden">
      <h5 id="welcomeMsg" class="mb-4 text-primary">í™˜ì˜í•©ë‹ˆë‹¤</h5>
      
      <button class="btn btn-outline-primary btn-menu" onclick="location.href='approval.html'">
        ğŸ“ ì „ìê²°ì¬ <span class="badge bg-primary float-end">GO</span>
      </button>

      <button class="btn btn-outline-info btn-menu" onclick="location.href='mypage.html'">
        ğŸ‘¤ ë§ˆì´í˜ì´ì§€ <span class="badge bg-info float-end text-white">GO</span>
      </button>
      
      <button class="btn btn-outline-success btn-menu hidden" id="btnAccounting" onclick="location.href='accounting.html'">
        ğŸ“’ íšŒê³„ê´€ë¦¬ <span class="badge bg-success float-end">GO</span>
      </button>
      
      <button class="btn btn-outline-dark btn-menu hidden" id="btnAdmin" onclick="location.href='admin_employee.html'">
        âš™ï¸ ì§ì› ë° ê¸‰ì—¬ ê´€ë¦¬ <span class="badge bg-dark float-end">GO</span>
      </button>

      <button class="btn btn-link text-muted mt-3" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

<script>
// ============================================================
// [ì„¤ì •] ìˆ˜í¼ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ (ì•„ê¹Œ ë©”ëª¨í•œ ê²ƒ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
// ============================================================
const SUPABASE_URL = 'https://êµ­ì¥ë‹˜í”„ë¡œì íŠ¸ID.supabase.co';
const SUPABASE_KEY = 'eyJ... (anon public key)';
const supabase = getSupabase();

function getSupabase() {
    return window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.onload = async function() {
    // 1. ì´ë¯¸ ë¡œê·¸ì¸í–ˆëŠ”ì§€ ë¸Œë¼ìš°ì € ì €ì¥ì†Œ(localStorage) ê²€ì‚¬
    const savedUser = localStorage.getItem('erp_user');
    
    if (savedUser) {
        // ë¡œê·¸ì¸ ê¸°ë¡ì´ ìˆìœ¼ë©´ ë°”ë¡œ ë©”ë‰´ ë³´ì—¬ì¤Œ
        showMenu(JSON.parse(savedUser));
    } else {
        // ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í¼ ì¤€ë¹„
        await loadUserList();
        showLoginForm();
    }
};

// [ê¸°ëŠ¥ 1] ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (GAS getEmployeeList_webapp ëŒ€ì²´)
async function loadUserList() {
    // ìˆ˜í¼ë² ì´ìŠ¤ì— "ref_employees" í…Œì´ë¸”ì—ì„œ ì´ë¦„ë§Œ ê°€ì ¸ì™€! (í‡´ì‚¬ì ì œì™¸)
    const { data, error } = await supabase
        .from('ref_employees')
        .select('emp_name')
        .eq('is_active', true);

    if (error) {
        alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + error.message);
        return;
    }

    const sel = document.getElementById("loginNameSelect");
    sel.innerHTML = "<option value=''>ì„ íƒí•˜ì„¸ìš”</option>";
    data.forEach(row => {
        const opt = document.createElement('option');
        opt.value = row.emp_name;
        opt.text = row.emp_name;
        sel.appendChild(opt);
    });
}

// [ê¸°ëŠ¥ 2] ë¡œê·¸ì¸ ì²˜ë¦¬ (GAS loginWithPin_webapp ëŒ€ì²´)
async function handleLogin() {
    const name = document.getElementById("loginNameSelect").value;
    const pin = document.getElementById("loginPin").value;

    if (!name || !pin) return alert("ì´ë¦„ê³¼ PINì„ ì…ë ¥í•˜ì„¸ìš”.");

    document.getElementById("loadingScreen").classList.remove("hidden");
    document.getElementById("mainCard").classList.add("hidden");

    // ìˆ˜í¼ë² ì´ìŠ¤ì— "ì´ë¦„ì´ë‘ PINì´ ì¼ì¹˜í•˜ëŠ” ì‚¬ëŒ ìˆì–´?" ë¬¼ì–´ë³´ê¸°
    // ì£¼ì˜: ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” PINì„ ì•”í˜¸í™”í•˜ê±°ë‚˜, ìˆ˜í¼ë² ì´ìŠ¤ Authë¥¼ ì“°ëŠ” ê²Œ ë” ì•ˆì „í•©ë‹ˆë‹¤.
    const { data, error } = await supabase
        .from('ref_employees')
        .select('*')
        .eq('emp_name', name)
        .eq('pin_code', pin)
        .single(); // ë”± í•œ ëª…ë§Œ ë‚˜ì™€ì•¼ í•¨

    if (error || !data) {
        document.getElementById("loadingScreen").classList.add("hidden");
        document.getElementById("mainCard").classList.remove("hidden");
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë¦„ì´ë‚˜ PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    } else {
        // ë¡œê·¸ì¸ ì„±ê³µ! ë¸Œë¼ìš°ì €ì— ì €ì¥í•´ë‘  (ì„¸ì…˜ ëŒ€ìš©)
        localStorage.setItem('erp_user', JSON.stringify(data));
        showMenu(data);
    }
}

// í™”ë©´ ì „í™˜ ë¡œì§
function showLoginForm() {
    document.getElementById("loadingScreen").classList.add("hidden");
    document.getElementById("mainCard").classList.remove("hidden");
    document.getElementById("loginForm").classList.remove("hidden");
    document.getElementById("menuArea").classList.add("hidden");
}

function showMenu(user) {
    document.getElementById("loadingScreen").classList.add("hidden");
    document.getElementById("mainCard").classList.remove("hidden");
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("menuArea").classList.remove("hidden");
    
    document.getElementById("welcomeMsg").innerText = `${user.emp_name} ${user.position}ë‹˜`;

    // ê¶Œí•œ(role)ì— ë”°ë¥¸ ë²„íŠ¼ í‘œì‹œ (GAS ì½”ë“œì™€ ë¡œì§ ë™ì¼)
    // admin, manager, staff 3ë‹¨ê³„ë¡œ ê°€ì •
    if (user.role === 'admin' || user.role === 'manager') {
        document.getElementById("btnAccounting").classList.remove("hidden");
    }
    if (user.role === 'admin') {
        document.getElementById("btnAdmin").classList.remove("hidden");
    }
}

function logout() {
    if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.removeItem('erp_user');
        location.reload();
    }
}
</script>
</body>
</html>
