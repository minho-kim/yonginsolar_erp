<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì„ì§ì› ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; padding: 20px; }
    .main-card { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .btn-rounded { border-radius: 50px; }
    .table-hover tbody tr { cursor: pointer; transition: background 0.2s; }
    .table-hover tbody tr:hover { background-color: #f8f9fa; transform: scale(1.002); }
    .status-badge { font-size: 0.75rem; padding: 5px 10px; border-radius: 12px; }
    
    .tab-content { padding: 20px; background: #fff; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 10px 10px; }
    .nav-tabs .nav-link { color: #666; cursor: pointer; }
    .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; }
    
    .modal-content { border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .form-control, .form-select { border-radius: 8px; }
    .d-none { display: none !important; }
  </style>
</head>
<body>

<div class="main-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold m-0">ğŸ‘¥ ì„ì§ì› ê´€ë¦¬</h4>
      <small class="text-muted">ì§ì› ì •ë³´ ë° ê¸‰ì—¬/ê·¼íƒœ í†µí•© ê´€ë¦¬</small>
    </div>
    <div>
      <button class="btn btn-light btn-sm btn-rounded me-1" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
      <button class="btn btn-outline-secondary btn-sm btn-rounded me-1" onclick="openSettings()">âš™ï¸ ìš”ìœ¨ ì„¤ì •</button>
      <button class="btn btn-primary btn-sm btn-rounded shadow-sm" onclick="openInviteModal()">âœ¨ ì‹ ê·œ ë“±ë¡</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle" style="font-size: 0.95rem;">
      <thead class="table-light text-secondary small">
        <tr>
          <th>ì‚¬ë²ˆ</th><th>ì´ë¦„ / ë¶€ì„œ</th><th>ì§ê¸‰</th><th>ìƒíƒœ</th><th>ì‹œìŠ¤í…œ ê¶Œí•œ</th>
        </tr>
      </thead>
      <tbody id="empListBody">
        <tr><td colspan="5" class="text-center p-4 text-muted">ë¡œë”© ì¤‘... â³</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title fw-bold">âš™ï¸ 4ëŒ€ë³´í—˜ ë° ë¹„ê³¼ì„¸ ì„¤ì •</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p class="small text-muted alert alert-light">ìš”ìœ¨ì€ <strong>í¼ì„¼íŠ¸(%)</strong> ë‹¨ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”.</p>
        <h6 class="fw-bold text-primary small border-bottom pb-1">ğŸ“Š ìš”ìœ¨ ì„¤ì • (Rates)</h6>
        <div class="row g-2 mb-3">
          <div class="col-6"><label class="small text-muted">êµ­ë¯¼ì—°ê¸ˆ</label><div class="input-group input-group-sm"><input type="number" id="set_pension" class="form-control" step="0.01"><span class="input-group-text">%</span></div></div>
          <div class="col-6"><label class="small text-muted">ê±´ê°•ë³´í—˜</label><div class="input-group input-group-sm"><input type="number" id="set_health" class="form-control" step="0.01"><span class="input-group-text">%</span></div></div>
          <div class="col-6"><label class="small text-muted">ì¥ê¸°ìš”ì–‘(ê±´ë³´ì˜%)</label><div class="input-group input-group-sm"><input type="number" id="set_care" class="form-control" step="0.01"><span class="input-group-text">%</span></div></div>
          <div class="col-6"><label class="small text-muted">ê³ ìš©ë³´í—˜</label><div class="input-group input-group-sm"><input type="number" id="set_employ" class="form-control" step="0.01"><span class="input-group-text">%</span></div></div>
          <div class="col-6"><label class="small text-muted">ì†Œë“ì„¸(ê°„ì´)</label><div class="input-group input-group-sm"><input type="number" id="set_income" class="form-control" step="0.01"><span class="input-group-text">%</span></div></div>
          <div class="col-6"><label class="small text-muted">ì§€ë°©ì†Œë“ì„¸(ì†Œë“ì„¸%)</label><div class="input-group input-group-sm"><input type="number" id="set_local" class="form-control" step="0.01"><span class="input-group-text">%</span></div></div>
        </div>
        <h6 class="fw-bold text-success small border-bottom pb-1">ğŸ’° ë¹„ê³¼ì„¸ í•œë„ (ì›”)</h6>
        <div class="row g-2">
          <div class="col-4"><label class="small text-muted">ì‹ëŒ€</label><input type="number" id="set_meal" class="form-control form-control-sm" step="10000"></div>
          <div class="col-4"><label class="small text-muted">ì°¨ëŸ‰ìœ ì§€</label><input type="number" id="set_car" class="form-control form-control-sm" step="10000"></div>
          <div class="col-4"><label class="small text-muted">ìœ¡ì•„ìˆ˜ë‹¹</label><input type="number" id="set_child" class="form-control form-control-sm" step="10000"></div>
        </div>
      </div>
      <div class="modal-footer p-2"><button class="btn btn-primary w-100 btn-rounded" onclick="saveSettings()">ì„¤ì • ì €ì¥</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="inviteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title fw-bold">âœ¨ ì§ì› ì‹ ê·œ ë“±ë¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="alert alert-light border text-center small mb-3">ğŸ†” ì‚¬ì›ë²ˆí˜¸ëŠ” ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div>
        <label class="small text-muted ms-1">ì´ë¦„</label><input type="text" id="newName" class="form-control mb-2" placeholder="í™ê¸¸ë™">
        <label class="small text-muted ms-1">ì´ë©”ì¼</label><input type="email" id="newEmail" class="form-control mb-2" placeholder="user@gmail.com">
        <div class="row g-2 mb-2">
          <div class="col"><label class="small text-muted ms-1">ì§ê¸‰</label><select id="newRank" class="form-select"><option>ì‚¬ì›</option><option>ëŒ€ë¦¬</option><option>ê³¼ì¥</option><option>ì°¨ì¥</option><option>ë¶€ì¥</option><option>ì´ì‚¬</option><option>êµ­ì¥</option><option>ì´ì‚¬ì¥</option></select></div>
          <div class="col"><label class="small text-muted ms-1">ê¶Œí•œ</label><select id="newRole" class="form-select"><option value="staff">ì¼ë°˜ (Staff)</option><option value="admin">ê´€ë¦¬ì (Admin)</option></select></div>
        </div>
        <div class="mb-3"><label class="small text-muted ms-1">ë¶€ì„œ</label><input type="text" id="newDept" class="form-control" placeholder="ê¸°íšíŒ€"></div>
        <button class="btn btn-primary w-100 btn-rounded py-2" onclick="runInvite()">ë“±ë¡í•˜ê¸°</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-white">
        <div><h5 class="modal-title fw-bold" id="detailName"></h5><span class="text-muted small" id="detailId"></span></div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0"> 
        <div class="px-3 pt-3">
          <ul class="nav nav-tabs" id="empTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabInfo">ğŸ“ ì •ë³´ & ê³„ì•½</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabSalary">ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabLog">ğŸ“… ê·¼íƒœ/í¬ìƒ</a></li>
          </ul>
        </div>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tabInfo">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">ê¸°ë³¸ ì—°ë´‰ ì„¤ì •</label>
                <div class="card p-3 bg-light border-0">
                  <div class="mb-2"><label class="small text-secondary">ì—°ë´‰ ê¸ˆì•¡ (ì›)</label><input type="number" id="editSalary" class="form-control" placeholder="ìˆ«ìë§Œ ì…ë ¥"></div>
                  <div class="mb-2"><label class="small text-secondary">ì ìš© ì‹œì‘ì¼</label><input type="date" id="salaryApplyDate" class="form-control"></div>
                  <button class="btn btn-primary btn-sm w-100 mt-2" id="btnSaveInfo" onclick="saveBasicInfo()">ì—°ë´‰ ì €ì¥</button>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">ê·¼ë¡œê³„ì•½ì„œ</label>
                <div id="contractView" class="mb-2"></div>
                <div class="input-group"><input type="text" id="contractUrlInput" class="form-control form-control-sm" placeholder="ê³„ì•½ì„œ PDF ë§í¬(URL)"><button class="btn btn-outline-secondary btn-sm" onclick="saveContractUrl()">ì €ì¥</button></div>
                <div class="form-text x-small">* êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê³µìœ  ë§í¬ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
              </div>
              
              <div class="col-12 mt-4 pt-3 border-top d-flex justify-content-end gap-2" id="btnResignArea">
                </div>
            </div>
          </div>

          <div class="tab-pane fade" id="tabSalary">
            <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
              <span class="small">ğŸ“¢ <strong>ì„¸ì „ ì—°ë´‰</strong> ê¸°ì¤€ìœ¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</span>
              <span class="badge bg-secondary" id="salaryStatusBadge">ì¡°íšŒ ì¤‘...</span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <label class="me-2 fw-bold small">ê·€ì†ì›”</label>
              <input type="month" id="salaryMonth" class="form-control form-control-sm w-auto" onchange="loadSalaryData()">
            </div>
            <div class="row g-2">
              <div class="col-6"><label class="small text-muted">ê¸°ë³¸ê¸‰</label><input type="number" id="payBasic" class="form-control fw-bold text-primary"></div>
              <div class="col-6"><label class="small text-muted">ì‹ëŒ€</label><input type="number" id="payMeal" class="form-control" value="0"></div>
              <div class="col-6"><label class="small text-muted">ì°¨ëŸ‰ìœ ì§€ë¹„</label><input type="number" id="payCar" class="form-control" value="0"></div>
              <div class="col-6"><label class="small text-muted">ìœ¡ì•„ìˆ˜ë‹¹</label><input type="number" id="payChild" class="form-control" value="0"></div>
              <div class="col-12"><label class="small text-muted">ìƒì—¬/ì„±ê³¼ê¸‰</label><input type="number" id="payBonus" class="form-control" value="0"></div>
            </div>
            <button id="btnSaveSalary" class="btn btn-success w-100 mt-3 btn-rounded" onclick="saveSalary()">ğŸ’¾ ê¸‰ì—¬ í™•ì • ë° ì €ì¥</button>
          </div>

          <div class="tab-pane fade" id="tabLog">
            <div class="card bg-light border-0 p-3 mb-3 text-center"><small class="text-muted">í˜„ì¬ ì”ì—¬ ì—°ì°¨</small><h3 class="fw-bold text-primary m-0" id="displayLeaveRemain">0ì¼</h3></div>
            <div class="mb-2"><label class="small text-muted">êµ¬ë¶„</label><select id="logType" class="form-select"><option value="ì§€ê¸‰">ğŸ ì§€ê¸‰ (í¬ìƒ ë“±)</option><option value="ì°¨ê°">âš ï¸ ì°¨ê° (ì§•ê³„ ë“±)</option></select></div>
            <div class="mb-2"><label class="small text-muted">ì¼ìˆ˜</label><input type="number" id="logValue" class="form-control" placeholder="ì˜ˆ: 1"></div>
            <div class="mb-3"><label class="small text-muted">ì‚¬ìœ </label><input type="text" id="logReason" class="form-control" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div>
            <button class="btn btn-primary w-100 btn-rounded" onclick="saveLog()">âœ… ë°˜ì˜í•˜ê¸°</button>
          </div>
        </div> 
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body text-center py-4"><p class="mb-0 fw-bold" id="alertBody"></p></div><div class="modal-footer justify-content-center p-1 border-0"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">í™•ì¸</h6></div><div class="modal-body text-center py-3" id="confirmBody"></div><div class="modal-footer justify-content-center border-0 pt-0"><button type="button" class="btn btn-secondary btn-sm me-2" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="button" class="btn btn-danger btn-sm" id="btnConfirmYes">í™•ì¸</button></div></div></div></div>

<script>
// Supabase ì„¤ì •
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let settings = {};
let currentEmpId = null, currentEmpName = null;
let confirmCallback = null;
let alertModal, confirmModal, settingsModal, inviteModal, detailModal;

window.onload = async function() {
    alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));
    detailModal = new bootstrap.Modal(document.getElementById('detailModal'));

    document.getElementById("btnConfirmYes").onclick = function() { if(confirmCallback) confirmCallback(); confirmModal.hide(); };
    document.getElementById("salaryMonth").value = new Date().toISOString().slice(0, 7);

    await loadList();
    await loadSettings();
};

function showAlert(msg) { document.getElementById("alertBody").innerText = msg; alertModal.show(); }
function showConfirm(msg, cb) { document.getElementById("confirmBody").innerHTML = msg; confirmCallback = cb; confirmModal.show(); }

// 1. ì§ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadList() {
    const tbody = document.getElementById("empListBody");
    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">ë¡œë”© ì¤‘...</td></tr>';
    
    const { data: list, error } = await _supabase.from('ref_employees').select('*').order('emp_id');
    
    if(error || !list) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = "";
    list.forEach(u => {
        let statusBadge = u.resign_date ? `<span class="badge bg-secondary">í‡´ì‚¬</span>` : `<span class="badge bg-success">ì¬ì§</span>`;
        let roleBadge = u.role === 'admin' ? '<span class="badge bg-danger">ê´€ë¦¬ì</span>' : '<span class="badge bg-light text-dark">ì¼ë°˜</span>';
        
        const tr = document.createElement("tr");
        if(u.resign_date) tr.style.opacity = "0.6";
        tr.onclick = () => openDetail(u);
        tr.innerHTML = `
            <td class="fw-bold text-secondary">${u.emp_id}</td>
            <td><div class="fw-bold">${u.emp_name}</div><div class="small text-muted">${u.department || '-'}</div></td>
            <td>${u.position}</td>
            <td>${statusBadge}</td>
            <td>${roleBadge}</td>
        `;
        tbody.appendChild(tr);
    });
}

// 2. ì„¤ì • (ìš”ìœ¨)
async function loadSettings() {
    const { data } = await _supabase.from('sys_tax_settings').select('*').eq('id', 1).single();
    if(data) settings = data;
}
function openSettings() {
    if(!settings.rate_pension) loadSettings();
    document.getElementById("set_pension").value = settings.rate_pension || 4.5;
    document.getElementById("set_health").value = settings.rate_health || 3.545;
    document.getElementById("set_care").value = settings.rate_care || 12.95;
    document.getElementById("set_employ").value = settings.rate_employ || 0.9;
    document.getElementById("set_income").value = settings.rate_income || 3.0;
    document.getElementById("set_local").value = settings.rate_local || 10.0;
    document.getElementById("set_meal").value = settings.limit_meal || 200000;
    document.getElementById("set_car").value = settings.limit_car || 200000;
    document.getElementById("set_child").value = settings.limit_child || 200000;
    settingsModal.show();
}
async function saveSettings() {
    const updates = {
        rate_pension: Number(document.getElementById("set_pension").value),
        rate_health: Number(document.getElementById("set_health").value),
        rate_care: Number(document.getElementById("set_care").value),
        rate_employ: Number(document.getElementById("set_employ").value),
        rate_income: Number(document.getElementById("set_income").value),
        rate_local: Number(document.getElementById("set_local").value),
        limit_meal: Number(document.getElementById("set_meal").value),
        limit_car: Number(document.getElementById("set_car").value),
        limit_child: Number(document.getElementById("set_child").value)
    };
    await _supabase.from('sys_tax_settings').upsert({id: 1, ...updates});
    showAlert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); settingsModal.hide(); loadSettings();
}

// 3. ì§ì› ë“±ë¡
function openInviteModal() { inviteModal.show(); }
async function runInvite() {
    const name = document.getElementById("newName").value;
    const email = document.getElementById("newEmail").value;
    if(!name || !email) return showAlert("ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
    
    // ì‚¬ë²ˆ ìƒì„± (ì—°ë„ + 3ìë¦¬ ìˆœë²ˆ)
    const year = new Date().getFullYear();
    const { count } = await _supabase.from('ref_employees').select('*', { count: 'exact', head: true }).like('emp_id', `${year}%`);
    const seq = (count || 0) + 1;
    const empId = `${year}${String(seq).padStart(3, '0')}`;

    const { error } = await _supabase.from('ref_employees').insert({
        emp_id: empId,
        emp_name: name,
        email: email,
        position: document.getElementById("newRank").value,
        role: document.getElementById("newRole").value,
        department: document.getElementById("newDept").value,
        hire_date: new Date().toISOString().slice(0, 10)
    });

    if(error) showAlert("ì˜¤ë¥˜: " + error.message);
    else { showAlert(`ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ë²ˆ: ${empId}`); inviteModal.hide(); loadList(); }
}

// 4. ì§ì› ìƒì„¸
function openDetail(u) {
    currentEmpId = u.emp_id; currentEmpName = u.emp_name;
    document.getElementById("detailName").innerText = u.emp_name;
    document.getElementById("detailId").innerText = u.emp_id;
    
    document.getElementById("editSalary").value = u.base_salary || 0;
    document.getElementById("salaryApplyDate").valueAsDate = new Date(); // ì˜¤ëŠ˜
    document.getElementById("contractUrlInput").value = u.contract_url || "";
    
    const viewDiv = document.getElementById("contractView");
    if(u.contract_url) viewDiv.innerHTML = `<a href="${u.contract_url}" target="_blank" class="btn btn-sm btn-info w-100 text-white">ğŸ“„ ê³„ì•½ì„œ ë³´ê¸°</a>`;
    else viewDiv.innerHTML = `<span class="text-muted small">ë¯¸ë“±ë¡</span>`;

    // í‡´ì‚¬ì ì²˜ë¦¬
    const area = document.getElementById("btnResignArea");
    if(u.resign_date) {
        document.getElementById("editSalary").disabled = true;
        document.getElementById("salaryApplyDate").disabled = true;
        document.getElementById("btnSaveInfo").classList.add("d-none");
        area.innerHTML = `<button class="btn btn-sm btn-warning" onclick="cancelResign()">â†©ï¸ í‡´ì‚¬ ì·¨ì†Œ</button>`;
    } else {
        document.getElementById("editSalary").disabled = false;
        document.getElementById("salaryApplyDate").disabled = false;
        document.getElementById("btnSaveInfo").classList.remove("d-none");
        area.innerHTML = `<button class="btn btn-sm btn-outline-danger" onclick="doResign()">â›” í‡´ì‚¬ ì²˜ë¦¬</button>`;
        loadSalaryData(); // ê¸‰ì—¬ íƒ­ ë¡œë“œ
        loadLeave(); // ê·¼íƒœ íƒ­ ë¡œë“œ
    }
    
    detailModal.show();
}

// ì •ë³´ ì €ì¥
async function saveBasicInfo() {
    const sal = Number(document.getElementById("editSalary").value);
    const date = document.getElementById("salaryApplyDate").value;
    // 1. ì •ë³´ ìˆ˜ì •
    await _supabase.from('ref_employees').update({ base_salary: sal }).eq('emp_id', currentEmpId);
    // 2. ì´ë ¥ ì €ì¥
    await _supabase.from('hr_salary_contracts').insert({ emp_id: currentEmpId, amount: sal, apply_date: date });
    showAlert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); loadList();
}
async function saveContractUrl() {
    const url = document.getElementById("contractUrlInput").value;
    await _supabase.from('ref_employees').update({ contract_url: url }).eq('emp_id', currentEmpId);
    showAlert("ê³„ì•½ì„œ ë§í¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// í‡´ì‚¬ ê´€ë¦¬
async function doResign() {
    showConfirm(`${currentEmpName}ë‹˜ì„ í‡´ì‚¬ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
        const today = new Date().toISOString().slice(0, 10);
        await _supabase.from('ref_employees').update({ resign_date: today }).eq('emp_id', currentEmpId);
        detailModal.hide(); loadList();
    });
}
async function cancelResign() {
    showConfirm(`í‡´ì‚¬ ì²˜ë¦¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
        await _supabase.from('ref_employees').update({ resign_date: null }).eq('emp_id', currentEmpId);
        detailModal.hide(); loadList();
    });
}

// 5. ê¸‰ì—¬ ê´€ë¦¬ (ìë™ê³„ì‚°)
async function loadSalaryData() {
    const month = document.getElementById("salaryMonth").value;
    const badge = document.getElementById("salaryStatusBadge");
    badge.innerText = "ì¡°íšŒ ì¤‘...";
    
    // 1) ê¸°ì¡´ ì €ì¥ëœ ê¸‰ì—¬ ìˆëŠ”ì§€ í™•ì¸
    const { data: saved } = await _supabase.from('hr_salary').select('*').eq('emp_id', currentEmpId).eq('year_month', month).single();
    
    if(saved) {
        document.getElementById("payBasic").value = saved.pay_basic;
        document.getElementById("payMeal").value = saved.pay_meal;
        document.getElementById("payCar").value = saved.pay_car;
        document.getElementById("payChild").value = saved.pay_child;
        document.getElementById("payBonus").value = saved.pay_bonus;
        badge.innerText = "ì €ì¥ëœ ë°ì´í„°"; badge.className = "badge bg-success";
    } else {
        // 2) ì—†ìœ¼ë©´ ì—°ë´‰ ê¸°ì¤€ ìë™ ê³„ì‚°
        const annual = Number(document.getElementById("editSalary").value) || 0;
        const monthly = Math.floor(annual / 12);
        
        // ë¹„ê³¼ì„¸ ì ìš©
        const meal = Math.min(settings.limit_meal, 200000); // ë³´í†µ ì‹ëŒ€ëŠ” í¬í•¨ or ë³„ë„ (ì—¬ê¸°ì„  í¬í•¨ ê°€ì • í›„ ë¶„ë¦¬)
        // ë¡œì§: ì›”ê¸‰ì— í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ë¶„ë¦¬
        // ê¸°ë³¸ê¸‰ = ì›”ê¸‰ - ë¹„ê³¼ì„¸í•­ëª©ë“¤
        let basic = monthly - meal; // ì°¨ëŸ‰ ë“±ì€ 0ìœ¼ë¡œ ê°€ì •
        
        document.getElementById("payBasic").value = basic > 0 ? basic : monthly;
        document.getElementById("payMeal").value = meal;
        document.getElementById("payCar").value = 0;
        document.getElementById("payChild").value = 0;
        document.getElementById("payBonus").value = 0;
        badge.innerText = "ì˜ˆìƒ (ë¯¸ì €ì¥)"; badge.className = "badge bg-secondary";
    }
}

async function saveSalary() {
    const month = document.getElementById("salaryMonth").value;
    const p_basic = Number(document.getElementById("payBasic").value);
    const p_meal = Number(document.getElementById("payMeal").value);
    const p_car = Number(document.getElementById("payCar").value);
    const p_child = Number(document.getElementById("payChild").value);
    const p_bonus = Number(document.getElementById("payBonus").value);
    
    const p_total = p_basic + p_meal + p_car + p_child + p_bonus;
    const tax_base = p_total - (p_meal + p_car + p_child); // ë¹„ê³¼ì„¸ ì œì™¸ (ë‹¨ìˆœí™”)

    // ì„¸ê¸ˆ ê³„ì‚° (ì•½ì‹)
    const pen = Math.floor(tax_base * (settings.rate_pension / 100));
    const hlt = Math.floor(tax_base * (settings.rate_health / 100));
    const care = Math.floor(hlt * (settings.rate_care / 100)); // ê±´ë³´ë£Œì˜ %
    const emp = Math.floor(tax_base * (settings.rate_employ / 100));
    const inc = Math.floor(tax_base * (settings.rate_income / 100)); // ê°„ì´ì„¸ì•¡ %
    const loc = Math.floor(inc * 0.1);
    
    const d_total = pen + hlt + care + emp + inc + loc;
    const net = p_total - d_total;

    const payload = {
        emp_id: currentEmpId, emp_name: currentEmpName, year_month: month,
        pay_basic: p_basic, pay_meal: p_meal, pay_car: p_car, pay_child: p_child, pay_bonus: p_bonus, pay_total: p_total,
        ded_pension: pen, ded_health: hlt, ded_care: care, ded_employ: emp, ded_income: inc, ded_local: loc, ded_total: d_total,
        net_pay: net
    };

    // Upsert (ê¸°ì¡´ ìˆìœ¼ë©´ ìˆ˜ì •, ì—†ìœ¼ë©´ ì¶”ê°€) -> year_month + emp_idê°€ ìœ ë‹ˆí¬í•´ì•¼ í•¨.
    // í•˜ì§€ë§Œ Supabase ê¸°ë³¸ insertëŠ” PK ì¶©ëŒì‹œ ì—ëŸ¬. select í›„ ë¶„ê¸°í•˜ê±°ë‚˜ id í™•ì¸ í•„ìš”.
    // í¸ì˜ìƒ delete í›„ insert (ê°€ì¥ í™•ì‹¤)
    await _supabase.from('hr_salary').delete().eq('emp_id', currentEmpId).eq('year_month', month);
    await _supabase.from('hr_salary').insert(payload);
    
    showAlert("ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); loadSalaryData();
}

// 6. ê·¼íƒœ (íœ´ê°€)
async function loadLeave() {
    // 1) ìë™ ë°œìƒ (ì…ì‚¬ì¼ ê¸°ì¤€)
    let generated = 0;
    const { data: emp } = await _supabase.from('ref_employees').select('hire_date').eq('emp_id', currentEmpId).single();
    if(emp && emp.hire_date) {
        const join = new Date(emp.hire_date);
        const now = new Date();
        const diffY = now.getFullYear() - join.getFullYear();
        if(diffY < 1) generated = (now.getMonth() - join.getMonth()); // 1ë…„ ë¯¸ë§Œ
        else generated = 15; // 1ë…„ ì´ìƒ (ë‹¨ìˆœí™”)
    }
    
    // 2) ì¡°ì • ë‚´ì—­
    let adjusted = 0;
    const { data: adjs } = await _supabase.from('hr_leave_adj').select('*').eq('emp_id', currentEmpId);
    if(adjs) adjs.forEach(a => { if(a.adj_type==='ì§€ê¸‰') adjusted+=Number(a.days); else adjusted-=Number(a.days); });
    
    // 3) ì‚¬ìš© ë‚´ì—­ (ê²°ì¬ ì™„ë£Œëœ ê±´)
    let used = 0;
    const { data: apps } = await _supabase.from('ref_approval').select('amount').eq('drafter_id', currentEmpId).eq('doc_type', 'íœ´ê°€').eq('status', 'ì™„ë£Œ');
    if(apps) apps.forEach(a => used+=Number(a.amount));
    
    document.getElementById("displayLeaveRemain").innerText = (generated + adjusted - used) + "ì¼";
}

async function saveLog() {
    const type = document.getElementById("logType").value; // ì§€ê¸‰/ì°¨ê°
    const val = Number(document.getElementById("logValue").value);
    const reason = document.getElementById("logReason").value;
    
    if(!val || !reason) return showAlert("ì¼ìˆ˜ì™€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    
    await _supabase.from('hr_leave_adj').insert({
        emp_id: currentEmpId,
        adj_type: type,
        days: val,
        reason: reason
    });
    showAlert("ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
    document.getElementById("logValue").value = "";
    document.getElementById("logReason").value = "";
    loadLeave();
}
</script>
</body>
</html>
