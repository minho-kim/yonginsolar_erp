<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>íšŒê³„ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; }
    .main-container { max-width: 650px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px; }
    
    .stat-card { flex: 1; padding: 15px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .bg-rev { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-exp { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-ast { background: linear-gradient(135deg, #3498db, #2980b9); }
    
    .sub-card { flex: 1; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #eee; background-color: #fff; }
    .text-vat { color: #d63384; font-weight: bold; } 
    .text-cash { color: #0d6efd; font-weight: bold; }
    
    .btn-report { width: 100%; margin-bottom: 20px; font-weight: bold; border-radius: 10px; }
    .readonly-input { background-color: #f8f9fa; cursor: pointer; }
    
    /* ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
    #reportContent { font-family: "Malgun Gothic", serif; font-size: 12px; }
    .rpt-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    .rpt-table th, .rpt-table td { border: 1px solid #ddd; padding: 6px 8px; }
    .rpt-table th { background: #f1f3f5; text-align: center; font-weight: bold; }
    .rpt-amt { text-align: right; font-family: 'Consolas', monospace; }
    .rpt-sec { background: #e9ecef; font-weight: bold; padding: 5px 10px; margin-top: 15px; border-left: 4px solid #495057; }
    
    .search-list-item:hover { background-color: #e9ecef; cursor: pointer; }
    .category-header { background: #f8f9fa; font-size: 0.85rem; font-weight: bold; color: #666; padding: 5px 10px; }
    
    .nav-pills .nav-link { color: #495057; cursor: pointer; }
    .nav-pills .nav-link.active { background-color: #0d6efd; color: white; }
    
    .hidden { display: none !important; }
    .ime-kr { ime-mode: active; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">ğŸ“’ íšŒê³„ ê´€ë¦¬</h4>
    <div>
      <button class="btn btn-outline-secondary btn-sm me-1" onclick="openInfoModal()">âš™ï¸ ì„¤ì •</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2">
    <div class="stat-card bg-rev"><div>ë§¤ì¶œ</div><div class="fw-bold" id="valRev">0</div></div>
    <div class="stat-card bg-exp"><div>ë¹„ìš©</div><div class="fw-bold" id="valExp">0</div></div>
    <div class="stat-card bg-ast"><div>ìì‚°</div><div class="fw-bold" id="valAst">0</div></div>
  </div>
  <div class="d-flex gap-2 mb-4">
    <div class="sub-card">
        <div>ğŸ’° í†µì¥ ì”ê³  (í˜„ê¸ˆì„±)</div>
        <div class="text-cash fs-5" id="valCash">0</div>
    </div>
    <div class="sub-card">
        <div>ğŸ§¾ ë¶€ê°€ì„¸ ì˜ˆìƒ</div>
        <div class="text-vat fs-5" id="valVat">0</div>
    </div>
  </div>
  <button class="btn btn-outline-dark btn-report shadow-sm" type="button" onclick="printReport()">ğŸ–¨ï¸ ê²°ì‚° ë³´ê³ ì„œ ìƒì„±</button>

  <ul class="nav nav-tabs mb-4" id="accTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabForm">ğŸ“ ì „í‘œì…ë ¥</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSync">ğŸ”„ ìë™ì—°ë™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistory" onclick="loadHistory()">ğŸ•’ ìµœê·¼ì „í‘œ</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tabForm">
      <form id="erpForm" onsubmit="handleFormSubmit(event)">
        <div class="row mb-3">
          <div class="col-6"><label class="small text-muted">ë‚ ì§œ</label><input type="date" class="form-control" id="dateField" required></div>
          <div class="col-6">
            <label class="small text-muted">í”„ë¡œì íŠ¸</label>
            <select class="form-select" id="projectSelect">
              <option value="ë³¸ì‚¬">ë³¸ì‚¬</option><option value="1í˜¸ê¸°">1í˜¸ê¸°</option><option value="2í˜¸ê¸°">2í˜¸ê¸°</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="small text-muted">ê±°ë˜ êµ¬ë¶„</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="inputType" id="t1" value="ë§¤ì¶œ" onchange="resetAccountInput()"><label class="btn btn-outline-success" for="t1">ë§¤ì¶œ</label>
            <input type="radio" class="btn-check" name="inputType" id="t2" value="ë¹„ìš©" checked onchange="resetAccountInput()"><label class="btn btn-outline-danger" for="t2">ë¹„ìš©</label>
            <input type="radio" class="btn-check" name="inputType" id="t3" value="ìì‚°" onchange="resetAccountInput()"><label class="btn btn-outline-primary" for="t3">ìì‚°</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="small text-muted">ê³„ì •ê³¼ëª©</label>
          <div class="input-group">
            <input type="text" class="form-control readonly-input ime-kr" id="displayAccount" placeholder="ì„ íƒí•˜ì„¸ìš”" readonly onclick="openSelModal()">
            <button class="btn btn-secondary" type="button" onclick="openSelModal()">ğŸ”</button>
            <button class="btn btn-outline-secondary" type="button" onclick="openAddModal()">â•</button>
          </div>
          <input type="hidden" id="hiddenItem"><input type="hidden" id="hiddenStandard">
        </div>

        <div class="mb-3"><label class="small text-muted">ì ìš”</label><input type="text" class="form-control ime-kr" id="inputDesc" required></div>
        <div class="mb-2"><label class="small text-muted">ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</label><input type="number" class="form-control form-control-lg" id="inputAmount" placeholder="0" required min="0"></div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
           <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="payMethod" onchange="toggleCard()"><label class="form-check-label small" for="payMethod">ğŸ’³ ì¹´ë“œê²°ì œ</label></div>
           <select class="form-select form-select-sm hidden ms-2" id="cardSelect" style="width: 120px;"><option value="">ì¹´ë“œì„ íƒ</option></select>
           <div class="ms-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="vatCheck" checked><label class="form-check-label small" for="vatCheck">ë¶€ê°€ì„¸í¬í•¨</label></div></div>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm mt-4" id="submitBtn">ì €ì¥í•˜ê¸°</button>
      </form>
    </div>

    <div class="tab-pane fade" id="tabSync">
      <div class="d-grid gap-3">
          <div class="card p-3 border-start border-5 border-info bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ’¼ ê¸‰ì—¬ ë° ë¹„ìš© ì—°ë™</h6><small class="text-muted">HR ê¸‰ì—¬ ë‚´ì—­ â†’ íšŒê³„ ì „í‘œ</small></div>
               <div class="d-flex align-items-center gap-2">
                   <input type="month" id="salaryMonth" class="form-control form-control-sm" style="width: 130px;">
                   <button class="btn btn-info btn-sm text-white" onclick="syncSalary()">ì‹¤í–‰</button>
               </div>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-success bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ’° ì¶œìê¸ˆ ì—°ë™</h6></div>
               <button class="btn btn-success btn-sm" onclick="alert('ì¤€ë¹„ì¤‘')">ì‹¤í–‰</button>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-warning bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ“ ì „ìê²°ì¬ ì—°ë™</h6></div>
               <button class="btn btn-warning btn-sm text-white" onclick="syncApprovals()">ì‹¤í–‰</button>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-danger bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ“… ì—°ë§ê²°ì‚° ë§ˆê°</h6></div>
               <button class="btn btn-danger btn-sm" onclick="alert('ì¤€ë¹„ì¤‘')">ì‹¤í–‰</button>
             </div>
          </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tabHistory">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold m-0">ìµœê·¼ ì „í‘œ 10ê±´</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="loadHistory()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="historyList" class="list-group"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="selectModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header p-2 bg-light"><h6 class="m-0 fw-bold">ê³„ì •ê³¼ëª© ì„ íƒ</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body p-0">
    <ul class="nav nav-pills nav-fill p-2 bg-white border-bottom" id="selTab">
      <li class="nav-item"><a class="nav-link active" onclick="filterAccounts('ë§¤ì¶œ', this)">ë§¤ì¶œ</a></li>
      <li class="nav-item"><a class="nav-link" onclick="filterAccounts('ë¹„ìš©', this)">ë¹„ìš©</a></li>
      <li class="nav-item"><a class="nav-link" onclick="filterAccounts('ìì‚°', this)">ìì‚°</a></li>
    </ul>
    <div id="accountList" style="height: 350px; overflow-y: auto;"></div>
</div></div></div></div>

<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">í•­ëª© ì¶”ê°€</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
    <label class="small text-muted mb-1">êµ¬ë¶„</label>
    <select class="form-select mb-3" id="addTypeSelect" onchange="updateAddCategorySelect()">
        <option value="ë§¤ì¶œ">ë§¤ì¶œ</option><option value="ë¹„ìš©" selected>ë¹„ìš©</option><option value="ìì‚°">ìì‚°</option>
    </select>
    
    <label class="small text-muted mb-1">ì¤‘ë¶„ë¥˜</label>
    <select class="form-select mb-2" id="addCategorySelect"></select>
    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="chkManualCat" onchange="toggleManualCat()">
        <label class="form-check-label small" for="chkManualCat">ì§ì ‘ ì…ë ¥</label>
    </div>
    <input type="text" class="form-control mb-3 hidden" id="manualCatInput" placeholder="ìƒˆ ì¤‘ë¶„ë¥˜ëª… ì…ë ¥">
    
    <label class="small text-muted mb-1">ìƒˆ í•­ëª©ëª…</label>
    <input type="text" class="form-control" id="addNewItemName" placeholder="ì˜ˆ: ì•¼ê·¼ì‹ëŒ€">
</div>
<div class="modal-footer"><button class="btn btn-primary w-100" onclick="confAdd()">ì¶”ê°€í•˜ê¸°</button></div></div></div></div>

<div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ì‚¬ì—…ê²°ì‚° ë³´ê³ ì„œ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light" id="reportContent"></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button><button class="btn btn-primary" onclick="realPrint()">ğŸ–¨ï¸ ì¸ì‡„</button></div></div></div></div>

<div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">âš™ï¸ ì„¤ì •</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="infoForm"><div class="mb-2"><label>ì¡°í•©ëª…</label><input type="text" class="form-control" id="orgName"></div><div class="mb-3"><label>ì„¤ë¦½ì¼</label><input type="date" class="form-control" id="estDate"></div><div class="mb-3"><label>í˜„ì¬ ì¶œìê¸ˆ ì´ì•¡</label><input type="text" class="form-control" id="totalCap" readonly value="0"></div></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveInfo()">ì €ì¥</button></div></div></div></div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let mData=[], cardData=[]; 
let selectModal, reportModal, addModal, infoModal;
let myInfo = null;

window.onload = async function() {
    selectModal = new bootstrap.Modal(document.getElementById('selectModal'));
    reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    addModal = new bootstrap.Modal(document.getElementById('addModal'));
    infoModal = new bootstrap.Modal(document.getElementById('infoModal'));

    const stored = localStorage.getItem('erp_user');
    if(stored) myInfo = JSON.parse(stored);

    document.getElementById('dateField').valueAsDate = new Date();
    document.getElementById('salaryMonth').value = new Date().toISOString().slice(0, 7);

    await Promise.all([ loadMasterData(), loadCards(), refreshDashboard() ]);
};

// 1. ë°ì´í„° ë¡œë“œ (ac_master: Tax_Free í™•ì¸ìš©)
async function loadMasterData() {
    const { data } = await _supabase.from('ac_master').select('*').order('Type').order('Standard').order('Item');
    if(data) mData = data;
}
async function loadCards() {
    const { data } = await _supabase.from('ref_cards').select('*');
    if(data) {
        cardData = data;
        const sel = document.getElementById("cardSelect");
        sel.innerHTML = "<option value=''>ì¹´ë“œì„ íƒ</option>";
        cardData.forEach(c => sel.add(new Option(c.card_alias, c.card_alias))); 
    }
}

// 2. ëŒ€ì‹œë³´ë“œ (ì •í™•í•œ ì”ê³  ë° ë¶€ê°€ì„¸ ê³„ì‚°)
async function refreshDashboard() {
    const { data } = await _supabase.from('ac_journal').select('*');
    let rev=0, exp=0, ast=0, vat=0;
    
    // [ì„¤ì •] ìì‚° ì¤‘ í˜„ê¸ˆì„± ìì‚°ìœ¼ë¡œ ì¹  ê³„ì •ê³¼ëª©ë“¤
    const cashAccounts = ['ë³´í†µì˜ˆê¸ˆ', 'í˜„ê¸ˆ', 'ì‹œì œê¸ˆ'];

    if(data) {
        data.forEach(r => {
            const debit = Number(r.Debit || 0);
            const credit = Number(r.Credit || 0);
            const amt = debit + credit; // ë‹¨ìˆœ ê±°ë˜ì•¡

            // ë§¤ì¶œ/ë¹„ìš© ì§‘ê³„
            if(r.Type === 'ë§¤ì¶œ') rev += credit;
            if(r.Type === 'ë¹„ìš©') exp += debit;

            // [í†µì¥ ì”ê³ ] ìì‚° ê³„ì • ì¤‘ í˜„ê¸ˆì„±ë§Œ ì°¨ë³€(ì¦ê°€) - ëŒ€ë³€(ê°ì†Œ) í•©ì‚°
            if(r.Type === 'ìì‚°' && cashAccounts.includes(r.Account)) {
                ast += (debit - credit);
            }
        });
        
        // [ë¶€ê°€ì„¸ ì •ë°€ ê³„ì‚°]
        // 1. ë§¤ì¶œì˜ 10% (ë¬´ì¡°ê±´ ë°œìƒí•œë‹¤ê³  ê°€ì •)
        const vatOutput = Math.round(rev / 1.1 * 0.1); 
        
        // 2. ë¹„ìš© ì¤‘ 'ê³¼ì„¸' í•­ëª©ë§Œ 10% ê³µì œ (ì¸ê±´ë¹„ ë“± ë©´ì„¸ ì œì™¸)
        let vatInput = 0;
        data.filter(r => r.Type === 'ë¹„ìš©').forEach(r => {
            // ac_masterì—ì„œ í•´ë‹¹ ê³„ì •ê³¼ëª© ì°¾ì•„ì„œ ë©´ì„¸ ì—¬ë¶€ í™•ì¸
            const master = mData.find(m => m.Item === r.Account);
            const isTaxFree = master ? (master.Tax_Free == 'TRUE' || master.Tax_Free === true) : false;
            
            // ê³¼ì„¸ í•­ëª©ì´ë©´ ë¶€ê°€ì„¸ ë°œë¼ë‚´ê¸°
            if (!isTaxFree) {
                const debit = Number(r.Debit || 0);
                vatInput += Math.round(debit / 1.1 * 0.1);
            }
        });
        
        vat = vatOutput - vatInput; // ë‚©ë¶€í•  ì„¸ì•¡ (ì˜ˆìƒ)
    }

    document.getElementById("valRev").innerText = rev.toLocaleString();
    document.getElementById("valExp").innerText = exp.toLocaleString();
    document.getElementById("valAst").innerText = ast.toLocaleString(); // ì´ê²ƒì´ í†µì¥ì”ê³ !
    document.getElementById("valVat").innerText = vat.toLocaleString();
    document.getElementById("valCash").innerText = ast.toLocaleString(); // í†µì¥ì”ê³ ì™€ ë™ì¼í•˜ê²Œ
}

// 3. ì „í‘œ ì €ì¥
async function handleFormSubmit(e) {
    e.preventDefault();
    const item = document.getElementById("hiddenItem").value;
    if(!item) return alert("ê³„ì •ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    
    const type = document.querySelector('input[name="inputType"]:checked').value;
    const totalAmt = Number(document.getElementById("inputAmount").value);
    
    // ì°¨ë³€/ëŒ€ë³€ ìë™ ë¶„ê°œ
    let debit = 0, credit = 0;
    if (type === 'ë¹„ìš©' || type === 'ìì‚°') debit = totalAmt;
    else credit = totalAmt; 

    const payload = {
        Date: document.getElementById("dateField").value,
        Type: type,
        Account: item,
        Description: document.getElementById("inputDesc").value,
        Debit: debit, Credit: credit,
        Project: document.getElementById("projectSelect").value,
        Operator: myInfo ? myInfo.emp_name : "unknown"
    };

    const { error } = await _supabase.from('ac_journal').insert(payload);
    if(error) alert("ì˜¤ë¥˜: " + error.message);
    else {
        alert("ì €ì¥ë¨");
        document.getElementById("inputDesc").value = "";
        document.getElementById("inputAmount").value = "";
        refreshDashboard();
    }
}

// 4. ëª¨ë‹¬: ê³„ì •ê³¼ëª© ì„ íƒ (íƒ­ ë°©ì‹ + ì¤‘ë¶„ë¥˜ í—¤ë”)
function resetAccountInput() {
    document.getElementById("displayAccount").value = "";
    document.getElementById("hiddenItem").value = "";
}
function openSelModal() {
    const type = document.querySelector('input[name="inputType"]:checked').value;
    // íƒ­ í™œì„±í™”
    const links = document.querySelectorAll('#selTab .nav-link');
    links.forEach(l => {
        if(l.innerText === type) l.classList.add('active');
        else l.classList.remove('active');
    });
    filterAccounts(type);
    selectModal.show();
}
function filterAccounts(type, clickedEl) {
    if(clickedEl) {
        document.querySelectorAll('#selTab .nav-link').forEach(l=>l.classList.remove('active'));
        clickedEl.classList.add('active');
    }
    
    const list = document.getElementById("accountList");
    list.innerHTML = "";
    
    const filtered = mData.filter(m => m.Type === type);
    // ì¤‘ë¶„ë¥˜(Standard)ë¡œ ê·¸ë£¹í•‘
    const grouped = {};
    filtered.forEach(m => {
        if(!grouped[m.Standard]) grouped[m.Standard] = [];
        grouped[m.Standard].push(m);
    });
    
    for (const [cat, items] of Object.entries(grouped)) {
        const header = document.createElement("div");
        header.className = "category-header";
        header.innerText = cat || "ê¸°íƒ€";
        list.appendChild(header);
        
        items.forEach(acc => {
            const d = document.createElement("div");
            d.className = "list-group-item list-group-item-action p-2 ps-3 border-0 border-bottom";
            d.innerHTML = `<span class="fw-bold">${acc.Item}</span>`;
            if(acc.Tax_Free == 'TRUE') d.innerHTML += ` <span class="badge bg-secondary ms-1" style="font-size:0.6rem">ë©´ì„¸</span>`;
            
            d.onclick = () => {
                document.getElementById("displayAccount").value = acc.Item;
                document.getElementById("hiddenItem").value = acc.Item;
                document.getElementById("hiddenStandard").value = acc.Standard;
                
                // ë©´ì„¸ë©´ ë¶€ê°€ì„¸ ì²´í¬ í•´ì œ
                const vat = document.getElementById("vatCheck");
                if(acc.Tax_Free == 'TRUE' || acc.Tax_Free === true) { vat.checked=false; vat.disabled=true; }
                else { vat.disabled=false; vat.checked=true; }
                
                selectModal.hide();
            };
            list.appendChild(d);
        });
    }
}

// 5. ëª¨ë‹¬: í•­ëª© ì¶”ê°€ (ë“œë¡­ë‹¤ìš´ ë¡œì§)
function openAddModal() {
    // í˜„ì¬ ì„ íƒëœ íƒ€ì…ìœ¼ë¡œ ì„¸íŒ…
    const type = document.querySelector('input[name="inputType"]:checked').value;
    document.getElementById("addTypeSelect").value = type;
    updateAddCategorySelect();
    addModal.show();
}
function updateAddCategorySelect() {
    const type = document.getElementById("addTypeSelect").value;
    const catSel = document.getElementById("addCategorySelect");
    catSel.innerHTML = "";
    
    // í•´ë‹¹ íƒ€ì…ì˜ ê¸°ì¡´ ì¤‘ë¶„ë¥˜ë§Œ ì¶”ì¶œ (ì¤‘ë³µì œê±°)
    const cats = [...new Set(mData.filter(m => m.Type === type).map(m => m.Standard))].sort();
    cats.forEach(c => catSel.add(new Option(c, c)));
}
function toggleManualCat() {
    const chk = document.getElementById("chkManualCat").checked;
    document.getElementById("addCategorySelect").classList.toggle("hidden", chk);
    document.getElementById("manualCatInput").classList.toggle("hidden", !chk);
}
async function confAdd() {
    const type = document.getElementById("addTypeSelect").value;
    const name = document.getElementById("addNewItemName").value;
    let cat = document.getElementById("addCategorySelect").value;
    if(document.getElementById("chkManualCat").checked) cat = document.getElementById("manualCatInput").value;
    
    if(!name || !cat) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
    
    await _supabase.from('ac_master').insert({Type:type, Standard:cat, Item:name});
    alert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    addModal.hide(); loadMasterData();
}

// 6. ê²°ì‚° ë³´ê³ ì„œ (ì´ë¯¸ì§€3 ìŠ¤íƒ€ì¼)
async function printReport() {
    const { data } = await _supabase.from('ac_journal').select('*');
    const { data: infoData } = await _supabase.from('ref_company_info').select('*');
    const info = {}; if(infoData) infoData.forEach(i=>info[i.key]=i.value);
    
    // ì§‘ê³„ ë³€ìˆ˜
    let asset={}, liab={}, equity={}, rev={}, exp={};
    let tAsset=0, tLiab=0, tEquity=0, tRev=0, tExp=0;
    
    // ìë³¸ê¸ˆ(ì¶œìê¸ˆ) ë³„ë„ ì¡°íšŒ (ì—¬ê¸°ì„œëŠ” ì „í‘œ í•©ê³„ë¡œ ê°€ì •í•˜ê±°ë‚˜ ì„¤ì •ê°’ ì‚¬ìš©)
    let capital = 0; // ì „í‘œì—ì„œ 'ìë³¸' í•©ê³„

    data.forEach(r => {
        const amt = Number(r.Debit || 0) + Number(r.Credit || 0); // ì ˆëŒ€ê°’ í•©ì‚° (ì°¨/ëŒ€ë³€ ìœ„ì¹˜ë¡œ +/- í•´ì•¼í•˜ë‚˜ ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”)
        // ì‹¤ì œë¡œëŠ”: ìì‚°(ì°¨ë³€+), ë¶€ì±„/ìë³¸(ëŒ€ë³€+), ë¹„ìš©(ì°¨ë³€+), ìˆ˜ìµ(ëŒ€ë³€+)
        // ì—¬ê¸°ì„œëŠ” Typeìœ¼ë¡œ êµ¬ë¶„
        
        // ì”ì•¡ ê³„ì‚° (ìì‚°=ì°¨-ëŒ€, ë¶€ì±„/ìë³¸=ëŒ€-ì°¨)
        const balance = (r.Type==='ìì‚°' || r.Type==='ë¹„ìš©') ? (Number(r.Debit)-Number(r.Credit)) : (Number(r.Credit)-Number(r.Debit));
        
        if(r.Type === 'ìì‚°') { asset[r.Account] = (asset[r.Account]||0) + balance; tAsset += balance; }
        else if(r.Type === 'ë¶€ì±„') { liab[r.Account] = (liab[r.Account]||0) + balance; tLiab += balance; }
        else if(r.Type === 'ìë³¸') { equity[r.Account] = (equity[r.Account]||0) + balance; tEquity += balance; }
        else if(r.Type === 'ë§¤ì¶œ') { rev[r.Account] = (rev[r.Account]||0) + balance; tRev += balance; }
        else if(r.Type === 'ë¹„ìš©') { exp[r.Account] = (exp[r.Account]||0) + balance; tExp += balance; }
    });

    const netIncome = tRev - tExp; // ë‹¹ê¸°ìˆœì´ìµ
    // ëŒ€ì°¨í‰í˜•: ìì‚° = ë¶€ì±„ + ìë³¸ + ì´ìµ
    const totalLiabEquity = tLiab + tEquity + netIncome;

    const html = `
        <div style="text-align:center; margin-bottom:20px;"><h2>ì‚¬ì—…ê²°ì‚° ë³´ê³ ì„œ</h2></div>
        <table class="rpt-table">
            <tr><th>íšŒê³„ì—°ë„</th><td colspan="3">${new Date().getFullYear()}ë…„ë„</td></tr>
            <tr><th>ì¡°ì§</th><td>${info.orgName||''}</td><th>ì„¤ë¦½ì¼</th><td>${info.estDate||''}</td></tr>
        </table>
        
        <div class="rpt-sec">â‘  ëŒ€ì°¨ëŒ€ì¡°í‘œ (ë‹¨ìœ„:ì›)</div>
        <table class="rpt-table">
            <tr><th width="50%">ìì‚°</th><th width="50%">ë¶€ì±„ ë° ìë³¸</th></tr>
            <tr>
                <td valign="top">
                    ${Object.keys(asset).map(k=>`<div class="d-flex justify-content-between"><span>- ${k}</span><span>${asset[k].toLocaleString()}</span></div>`).join('')}
                    <div class="d-flex justify-content-between border-top mt-2 pt-2 fw-bold bg-light"><span>ìì‚° ì´ê³„</span><span>${tAsset.toLocaleString()}</span></div>
                </td>
                <td valign="top">
                    <div class="fw-bold text-muted mb-1">[ë¶€ì±„]</div>
                    ${Object.keys(liab).map(k=>`<div class="d-flex justify-content-between"><span>- ${k}</span><span>${liab[k].toLocaleString()}</span></div>`).join('')}
                    <div class="fw-bold text-muted mt-3 mb-1">[ìë³¸]</div>
                    ${Object.keys(equity).map(k=>`<div class="d-flex justify-content-between"><span>- ${k}</span><span>${equity[k].toLocaleString()}</span></div>`).join('')}
                    <div class="d-flex justify-content-between text-primary"><span>+ ë‹¹ê¸°ìˆœì´ìµ</span><span>${netIncome.toLocaleString()}</span></div>
                    <div class="d-flex justify-content-between border-top mt-2 pt-2 fw-bold bg-light"><span>ë¶€ì±„/ìë³¸ ì´ê³„</span><span>${totalLiabEquity.toLocaleString()}</span></div>
                </td>
            </tr>
        </table>

        <div class="rpt-sec">â‘¡ ì†ìµê³„ì‚°ì„œ (ë‹¨ìœ„:ì›)</div>
        <table class="rpt-table">
            <tr><th colspan="2">ê³¼ëª©</th><th>ê¸ˆì•¡</th></tr>
            <tr class="bg-light"><td colspan="2"><b>I. ë§¤ ì¶œ ì•¡</b></td><td class="rpt-amt"><b>${tRev.toLocaleString()}</b></td></tr>
            ${Object.keys(rev).map(k=>`<tr><td width="20"></td><td>${k}</td><td class="rpt-amt">${rev[k].toLocaleString()}</td></tr>`).join('')}
            
            <tr class="bg-light"><td colspan="2"><b>II. ì˜ì—…ë¹„ìš©</b></td><td class="rpt-amt"><b>${tExp.toLocaleString()}</b></td></tr>
            ${Object.keys(exp).map(k=>`<tr><td></td><td>${k}</td><td class="rpt-amt">${exp[k].toLocaleString()}</td></tr>`).join('')}
            
            <tr style="border-top:2px solid #333; background:#fff3cd;"><td colspan="2" class="text-center fw-bold">III. ë‹¹ê¸°ìˆœì´ìµ</td><td class="rpt-amt fw-bold text-danger">${netIncome.toLocaleString()}</td></tr>
        </table>
    `;
    
    document.getElementById("reportContent").innerHTML = html;
    reportModal.show();
}
function realPrint() {
    const w = window.open();
    w.document.write(`<html><head><title>ê²°ì‚°ë³´ê³ ì„œ</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><style>body{padding:20px; font-family:'Malgun Gothic';} .rpt-table{width:100%; border-collapse:collapse; margin-bottom:15px;} .rpt-table th, .rpt-table td{border:1px solid #000; padding:5px;} .rpt-table th{background:#eee; text-align:center;} .rpt-amt{text-align:right;} .rpt-sec{background:#eee; font-weight:bold; padding:5px; margin-top:20px; border:1px solid #000;}</style></head><body>${document.getElementById("reportContent").innerHTML}</body></html>`);
    w.print(); w.close();
}

// ê¸°íƒ€ ê¸°ëŠ¥ë“¤ (ìµœê·¼ì „í‘œ, ì‚­ì œ, ì„¤ì • ë“±) - ê¸°ì¡´ ë¡œì§ ìœ ì§€
async function loadHistory() {
    const el = document.getElementById("historyList");
    el.innerHTML = "ë¡œë”© ì¤‘...";
    const { data } = await _supabase.from('ac_journal').select('*').order('Date', {ascending:false}).limit(10);
    el.innerHTML = "";
    if(data) data.forEach(item => {
        const amt = Number(item.Debit||0) + Number(item.Credit||0);
        el.innerHTML += `<div class="list-group-item d-flex justify-content-between"><div><span class="badge bg-secondary me-1">${item.Type}</span><b>${item.Account}</b> <small>${item.Description}</small></div><div class="fw-bold">${amt.toLocaleString()} <span class="text-danger cursor-pointer" onclick="deleteTx('${item.id}')">Ã—</span></div></div>`;
    });
}
async function deleteTx(id) { if(confirm("ì‚­ì œ?")) { await _supabase.from('ac_journal').delete().eq('id', id); loadHistory(); refreshDashboard(); }}
function toggleCard() { document.getElementById("cardSelect").classList.toggle("hidden", !document.getElementById("payMethod").checked); }
async function openInfoModal() {
    const { data } = await _supabase.from('ref_company_info').select('*');
    const map = {}; if(data) data.forEach(i=>map[i.key]=i.value);
    document.getElementById("orgName").value = map['orgName']||"";
    document.getElementById("estDate").value = map['estDate']||"";
    
    // ì¶œìê¸ˆ ì´ì•¡ ê³„ì‚°
    const { data: cap } = await _supabase.from('ac_journal').select('Credit').eq('Account', 'ì¶œìê¸ˆ');
    let totalCap = 0; if(cap) cap.forEach(c=>totalCap+=c.Credit);
    document.getElementById("totalCap").value = totalCap.toLocaleString();
    
    infoModal.show();
}
async function saveInfo() {
    const updates = [{ key: 'orgName', value: document.getElementById("orgName").value }, { key: 'estDate', value: document.getElementById("estDate").value }];
    await _supabase.from('ref_company_info').upsert(updates);
    alert("ì €ì¥ë¨"); infoModal.hide();
}
async function syncSalary() {
    const ym = document.getElementById("salaryMonth").value;
    if(!confirm(ym+"ì›” ê¸‰ì—¬ ì—°ë™?")) return;
    const { data: salaries } = await _supabase.from('hr_salary').select('*').eq('year_month', ym);
    if(!salaries || !salaries.length) return alert("ë°ì´í„° ì—†ìŒ");
    let total=0; salaries.forEach(s=>total+=Number(s.pay_total));
    await _supabase.from('ac_journal').insert({Date:`${ym}-25`, Type:'ë¹„ìš©', Account:'ê¸‰ì—¬', Description:`${ym}ì›” ê¸‰ì—¬`, Debit:total, Credit:0, Project:'ë³¸ì‚¬', Operator:'System'});
    alert("ì™„ë£Œ"); refreshDashboard();
}
</script>
</body>
</html>
