<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>íšŒê³„ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif; }
    .main-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px; }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .stat-card { flex: 1; padding: 15px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .bg-rev { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-exp { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-ast { background: linear-gradient(135deg, #3498db, #2980b9); }
    
    .sub-card { flex: 1; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #eee; background-color: #fff; }
    .text-vat { color: #d63384; font-weight: bold; } 
    .text-cash { color: #0d6efd; font-weight: bold; }
    
    .btn-report { width: 100%; margin-bottom: 20px; font-weight: bold; border-radius: 10px; }
    .readonly-input { background-color: #f8f9fa; cursor: pointer; }
    
    /* ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
    #reportContent { font-family: "Malgun Gothic", serif; font-size: 13px; }
    .tbl { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .tbl th, .tbl td { border: 1px solid #ddd; padding: 6px; }
    .tbl th { background: #f8f9fa; text-align: center; font-weight: bold; }
    .amt { text-align: right; }
    .sec { font-weight: bold; margin: 15px 0 5px 0; background: #eee; padding: 5px; }
    
    .vat-wrapper { display: flex; align-items: center; justify-content: flex-end; margin-bottom: 5px; }
    .search-list-item:hover { background-color: #e9ecef; cursor: pointer; }
    .special-box { background-color: #f1f3f5; border-radius: 8px; padding: 10px; margin-bottom: 15px; border-left: 4px solid #6c757d; }
    .asset-box { background-color: #e8f5e9; border-radius: 8px; padding: 10px; margin-bottom: 15px; border-left: 4px solid #28a745; }
    .history-row { font-size: 0.9rem; }
    
    .ime-kr { ime-mode: active; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">ğŸ“’ íšŒê³„ ê´€ë¦¬</h4>
    <div>
      <button class="btn btn-outline-secondary btn-sm me-1" onclick="openInfoModal()">âš™ï¸ ì„¤ì •</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2">
    <div class="stat-card bg-rev"><div>ë§¤ì¶œ</div><div class="fw-bold" id="valRev">0</div></div>
    <div class="stat-card bg-exp"><div>ë¹„ìš©</div><div class="fw-bold" id="valExp">0</div></div>
    <div class="stat-card bg-ast"><div>ìì‚°</div><div class="fw-bold" id="valAst">0</div></div>
  </div>
  <div class="d-flex gap-2 mb-4">
    <div class="sub-card"><div>ğŸ’° í†µì¥ ì”ê³  (ì¶”ì •)</div><div class="text-cash" id="valCash">0</div></div>
    <div class="sub-card"><div>ğŸ§¾ ë¶€ê°€ì„¸ ì˜ˆìƒ</div><div class="text-vat" id="valVat">0</div></div>
  </div>
  <button class="btn btn-outline-dark btn-report" type="button" onclick="printReport()">ğŸ–¨ï¸ ê²°ì‚° ë³´ê³ ì„œ ìƒì„±</button>

  <ul class="nav nav-tabs mb-4" id="accTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabForm">ğŸ“ ì „í‘œì…ë ¥</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSync">ğŸ”„ ìë™ì—°ë™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistory" onclick="loadHistory()">ğŸ•’ ìµœê·¼ì „í‘œ</button></li>
  </ul>

  <div class="tab-content">
    
    <div class="tab-pane fade show active" id="tabForm">
      <form id="erpForm" onsubmit="handleFormSubmit(event)">
        <div class="row mb-3">
          <div class="col-6">
            <label class="small text-muted">ë‚ ì§œ</label>
            <input type="date" class="form-control" name="inputDate" id="dateField" required>
          </div>
          <div class="col-6">
            <label class="small text-muted">í”„ë¡œì íŠ¸</label>
            <select class="form-select" name="inputProject" id="projectSelect">
              <option value="ë³¸ì‚¬">ë³¸ì‚¬</option><option value="1í˜¸ê¸°">1í˜¸ê¸° ë°œì „ì†Œ</option><option value="2í˜¸ê¸°">2í˜¸ê¸° ë°œì „ì†Œ</option>
            </select>
          </div>
        </div>

        <div class="mb-3 p-2 border rounded bg-light">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="small text-muted fw-bold">ê±°ë˜ êµ¬ë¶„</label>
            <span class="badge bg-secondary" id="modeBadge">ì¼ë°˜</span>
          </div>
          <div class="d-flex gap-2">
             <input type="radio" class="btn-check" name="settleMode" id="smNorm" value="" checked onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-secondary flex-fill" for="smNorm">ì¼ë°˜ê±°ë˜</label>

             <input type="radio" class="btn-check" name="settleMode" id="smPre" value="pre_expense" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-primary flex-fill" for="smPre">ì„¤ë¦½ì „/ê°œì¸</label>

             <input type="radio" class="btn-check" name="settleMode" id="smReim" value="reimburse" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-danger flex-fill" for="smReim">ì •ì‚°ì§€ê¸‰</label>
          </div>
          
          <div id="payerInputDiv" class="mt-2" style="display:none;">
            <div class="input-group input-group-sm">
              <span class="input-group-text fw-bold" id="payerLabel">ì´ë¦„</span>
              <input type="text" class="form-control ime-kr" name="payerName" id="payerName" placeholder="í™ê¸¸ë™">
            </div>
            <div id="preExpenseHelp" class="form-text x-small text-primary hidden"> * ê°œì¸ ì¹´ë“œë¡œ ì§€ì¶œí•œ ë¹„ìš©/ìì‚° (ë¯¸ì§€ê¸‰ê¸ˆ ì²˜ë¦¬) </div>
            <div id="reimburseHelp" class="form-text x-small text-danger hidden"> * ë¯¸ì§€ê¸‰ê¸ˆì„ ê°œì¸ì—ê²Œ ì´ì²´í•˜ì—¬ ì •ì‚°í•¨ </div>
          </div>
        </div>

        <div class="mb-3">
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="inputType" id="t1" value="ë§¤ì¶œ" onchange="handleTypeChange()"><label class="btn btn-outline-success" for="t1">ë§¤ì¶œ</label>
            <input type="radio" class="btn-check" name="inputType" id="t2" value="ë¹„ìš©" checked onchange="handleTypeChange()"><label class="btn btn-outline-danger" for="t2">ë¹„ìš©</label>
            <input type="radio" class="btn-check" name="inputType" id="t3" value="ìì‚°" onchange="handleTypeChange()"><label class="btn btn-outline-primary" for="t3">ìì‚°</label>
          </div>
          <div id="capitalNotice" class="alert alert-secondary mt-2 p-2 small text-center hidden"><strong>â„¹ï¸ ì¶œìê¸ˆ ë°˜í™˜ ì „ìš©</strong><input type="hidden" name="capitalType" value="out"></div>
        </div>

        <div class="mb-3">
          <label class="small text-muted">ê³„ì •ê³¼ëª©</label>
          <div class="input-group">
            <input type="text" class="form-control readonly-input ime-kr" id="displayAccount" placeholder="í´ë¦­í•˜ì—¬ ê²€ìƒ‰" readonly onclick="openSelModal()">
            <button class="btn btn-secondary" type="button" onclick="openSelModal()">ğŸ”</button>
            <button class="btn btn-outline-secondary" type="button" id="btnAddAccount" onclick="openAddModal()">â•</button>
          </div>
          <input type="hidden" name="inputItem" id="hiddenItem">
          <input type="hidden" name="inputStandard" id="hiddenStandard"> <input type="hidden" name="specialMode" id="specialMode">
        </div>

        <div id="dynamicArea"></div>

        <div class="mb-3"><label class="small text-muted">ì ìš”</label><input type="text" class="form-control ime-kr" name="inputDesc" id="inputDesc" required></div>
        <div class="mb-2"><label class="small text-muted">ê¸ˆì•¡ (ê³µê¸‰ê°€+ì„¸ì•¡ í•©ê³„)</label><input type="number" class="form-control form-control-lg" name="inputAmount" id="inputAmount" placeholder="0" required min="0"></div>
        
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center" id="cardOptionDiv" style="flex:1;">
             <div class="form-check form-switch me-2"><input class="form-check-input" type="checkbox" id="payMethod" name="payMethod" value="card" onchange="toggleCardSelect()"><label class="form-check-label small" for="payMethod">ğŸ’³ ì¹´ë“œ</label></div>
             <select class="form-select form-select-sm hidden" id="cardSelect" name="selectedCardName" style="max-width: 150px;"><option value="">ì„ íƒ</option></select>
           </div>
           <div class="vat-wrapper"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="vatCheck" name="vatCheck" checked><label class="form-check-label small" for="vatCheck">ë¶€ê°€ì„¸í¬í•¨</label></div></div>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm mt-3" id="submitBtn">ì €ì¥í•˜ê¸°</button>
      </form>
    </div>

    <div class="tab-pane fade" id="tabSync">
      <div class="card p-3 mb-2 border" style="border-left: 5px solid #0dcaf0;">
         <div class="d-flex justify-content-between align-items-center">
           <div><h6 class="fw-bold mb-1">ğŸ’¼ ê¸‰ì—¬ ë° ë¹„ìš© ì—°ë™</h6><small class="text-muted">ê¸‰ì—¬ëŒ€ì¥(HR) â†’ íšŒê³„ì „í‘œ</small></div>
           <div class="d-flex align-items-center gap-2">
               <input type="month" id="salaryMonth" class="form-control form-control-sm" style="width: 130px;">
               <button class="btn btn-info btn-sm text-white" onclick="syncSalary()">ì‹¤í–‰</button>
           </div>
         </div>
      </div>
      <div class="alert alert-light text-center small text-muted">
        ì¶œìê¸ˆ/ë°°ë‹¹ê¸ˆ/ê²°ì‚° ì—°ë™ ê¸°ëŠ¥ì€<br>ë‹¤ìŒ ì—…ë°ì´íŠ¸(v1.3.0)ì— ì œê³µë©ë‹ˆë‹¤.
      </div>
    </div>

    <div class="tab-pane fade" id="tabHistory">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold m-0">ìµœê·¼ ì „í‘œ 10ê±´</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="loadHistory()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="historyList" class="list-group"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="selectModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header p-2"><h6 class="m-0">ê³„ì •ê³¼ëª© ê²€ìƒ‰</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-2"><input type="text" class="form-control mb-2 ime-kr" id="accountSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" onkeyup="filterAccounts()"><div class="list-group" id="accountSearchResult" style="height:300px;overflow-y:auto;"></div></div></div></div></div>

<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">í•­ëª© ì¶”ê°€</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" class="form-control mb-2" id="addMediumInput" placeholder="ì¤‘ë¶„ë¥˜ (ì˜ˆ: ìš´ì˜ë¹„)"><input type="text" class="form-control" id="addName" placeholder="í•­ëª©ëª… (ì˜ˆ: íšŒì‹ë¹„)"></div><div class="modal-footer"><button class="btn btn-primary" onclick="confAdd()">ì¶”ê°€</button></div></div></div></div>

<div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ğŸ“„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="reportContent"></div><div class="modal-footer"><button class="btn btn-primary" onclick="realPrint()">ğŸ–¨ï¸ ì¸ì‡„</button></div></div></div></div>

<div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">âš™ï¸ ì¡°í•© ì •ë³´ ì„¤ì •</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="infoForm"><div class="mb-2"><label>ì¡°í•©ëª…</label><input type="text" class="form-control" id="orgName"></div><div class="mb-3"><label>ì„¤ë¦½ì¼</label><input type="date" class="form-control" id="estDate"></div></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveInfo()">ì €ì¥</button></div></div></div></div>

<script>
// [ì„¤ì •] ìˆ˜í¼ë² ì´ìŠ¤ ì—°ê²°
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let mData=[], cardData=[]; // ê³„ì •ê³¼ëª©, ì¹´ë“œ ë°ì´í„°
let selectModal, reportModal, addModal, infoModal;

window.onload = async function() {
    selectModal = new bootstrap.Modal(document.getElementById('selectModal'));
    reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    addModal = new bootstrap.Modal(document.getElementById('addModal'));
    infoModal = new bootstrap.Modal(document.getElementById('infoModal'));

    document.getElementById('dateField').valueAsDate = new Date();
    document.getElementById('salaryMonth').value = new Date().toISOString().slice(0, 7);

    await Promise.all([ loadMasterData(), loadCards(), refreshDashboard() ]);
};

// 1. ê¸°ì´ˆ ë°ì´í„° ë¡œë“œ (ê³„ì •ê³¼ëª©, ì¹´ë“œ)
async function loadMasterData() {
    const { data } = await _supabase.from('acc_accounts').select('*').order('name');
    if(data) mData = data;
}
async function loadCards() {
    const { data } = await _supabase.from('acc_cards').select('*');
    if(data) {
        cardData = data;
        const sel = document.getElementById("cardSelect");
        sel.innerHTML = "<option value=''>ì„ íƒ</option>";
        cardData.forEach(c => sel.add(new Option(c.card_name, c.card_name)));
    }
}

// 2. ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ (ì „í‘œ ì§‘ê³„)
async function refreshDashboard() {
    const { data } = await _supabase.from('acc_transactions').select('*');
    let rev=0, exp=0, ast=0, vat=0;
    
    if(data) {
        data.forEach(r => {
            const amt = Number(r.amount);
            const tax = Number(r.vat);
            if(r.type === 'ë§¤ì¶œ') { rev += amt; vat += tax; }
            else if(r.type === 'ë¹„ìš©') { exp += amt; vat -= tax; }
            else if(r.type === 'ìì‚°') { ast += amt; }
        });
    }
    document.getElementById("valRev").innerText = rev.toLocaleString();
    document.getElementById("valExp").innerText = exp.toLocaleString();
    document.getElementById("valAst").innerText = ast.toLocaleString();
    document.getElementById("valVat").innerText = vat.toLocaleString();
    document.getElementById("valCash").innerText = (rev - exp).toLocaleString(); // ì¶”ì • ì”ê³ 
}

// 3. ê³„ì •ê³¼ëª© ê²€ìƒ‰ ë° ì„ íƒ
function openSelModal(){ 
    document.getElementById("accountSearchInput").value = ""; 
    filterAccounts(); 
    selectModal.show();
}
function filterAccounts() {
    const keyword = document.getElementById("accountSearchInput").value.trim();
    const curType = document.querySelector('input[name="inputType"]:checked').value; 
    const listEl = document.getElementById("accountSearchResult");
    listEl.innerHTML = "";
    
    const filtered = mData.filter(item => {
        const matchType = (curType === 'ìì‚°') ? ['ìì‚°','ë¶€ì±„','ìë³¸'].includes(item.type) : (item.type === curType);
        const matchKey = item.name.includes(keyword) || (item.category && item.category.includes(keyword));
        return matchType && matchKey;
    });

    filtered.forEach(acc => {
        const div = document.createElement("div");
        div.className = "list-group-item list-group-item-action search-list-item";
        div.innerHTML = `<strong>${acc.name}</strong> <small class="text-muted">(${acc.category})</small>`;
        div.onclick = () => selectAccount(acc);
        listEl.appendChild(div);
    });
}
function selectAccount(acc) {
    document.getElementById("displayAccount").value = acc.name;
    document.getElementById("hiddenItem").value = acc.name;
    document.getElementById("hiddenStandard").value = acc.category;
    updateDynamicUI(acc);
    selectModal.hide();
}

function updateDynamicUI(acc) {
    const area = document.getElementById("dynamicArea");
    const specialInput = document.getElementById("specialMode");
    const vatCheck = document.getElementById("vatCheck");
    const cardDiv = document.getElementById("cardOptionDiv");
    
    area.innerHTML = ""; specialInput.value = "";
    
    if (acc.is_tax_free) { vatCheck.checked = false; vatCheck.disabled = true; } 
    else { vatCheck.disabled = false; vatCheck.checked = true; }
    
    if (acc.special_code === 'salary') {
        specialInput.value = "salary";
        area.innerHTML = `<div class="special-box"><small class="text-success fw-bold">â„¹ï¸ ê¸‰ì—¬/ì¸ê±´ë¹„</small><br>ì¹´ë“œ/ë¶€ê°€ì„¸ ì œì™¸ ì²˜ë¦¬</div>`;
        cardDiv.classList.add('hidden'); vatCheck.checked=false;
    } else {
        cardDiv.classList.remove('hidden');
    }
}

// 4. ì „í‘œ ì €ì¥
async function handleFormSubmit(e) {
    e.preventDefault();
    if(!document.getElementById("hiddenItem").value) return alert("ê³„ì •ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    
    const f = document.getElementById("erpForm");
    const totalAmt = Number(document.getElementById("inputAmount").value);
    
    // ë¶€ê°€ì„¸ ê³„ì‚°
    let supply = totalAmt;
    let vat = 0;
    if(document.getElementById("vatCheck").checked) {
        supply = Math.round(totalAmt / 1.1);
        vat = totalAmt - supply;
    }

    const payload = {
        date: document.getElementById("dateField").value,
        type: document.querySelector('input[name="inputType"]:checked').value,
        account_name: document.getElementById("hiddenItem").value,
        category: document.getElementById("hiddenStandard").value,
        description: document.getElementById("inputDesc").value,
        amount: supply,
        vat: vat,
        payer: document.getElementById("payerName").value,
        method: document.getElementById("payMethod").checked ? document.getElementById("cardSelect").value : "ê³„ì¢Œ/í˜„ê¸ˆ",
        project: document.getElementById("projectSelect").value
    };

    const { error } = await _supabase.from('acc_transactions').insert(payload);
    
    if(error) alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
    else {
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        f.reset();
        document.getElementById("smNorm").checked = true;
        refreshDashboard();
    }
}

// 5. ìµœê·¼ ì „í‘œ ë¶ˆëŸ¬ì˜¤ê¸° & ì‚­ì œ
async function loadHistory() {
    const el = document.getElementById("historyList");
    el.innerHTML = "ë¡œë”© ì¤‘...";
    
    const { data } = await _supabase.from('acc_transactions').select('*').order('date', {ascending:false}).order('created_at', {ascending:false}).limit(10);
    
    el.innerHTML = "";
    if(!data || data.length === 0) { el.innerHTML = "<div class='text-center p-3 text-muted'>ë‚´ì—­ ì—†ìŒ</div>"; return; }
    
    data.forEach(item => {
        const total = Number(item.amount) + Number(item.vat);
        const div = document.createElement("div");
        div.className = "list-group-item d-flex justify-content-between align-items-center";
        div.innerHTML = `
            <div>
                <span class="badge bg-secondary me-1">${item.type}</span>
                <strong>${item.account_name}</strong> <small class="text-muted">(${item.date})</small>
                <div class="small text-muted">${item.description}</div>
            </div>
            <div class="text-end">
                <div class="fw-bold">${total.toLocaleString()}</div>
                <button class="btn btn-outline-danger btn-sm p-0 px-2" onclick="deleteTx(${item.id})">ì‚­ì œ</button>
            </div>
        `;
        el.appendChild(div);
    });
}

async function deleteTx(id) {
    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const { error } = await _supabase.from('acc_transactions').delete().eq('id', id);
    if(error) alert("ì‚­ì œ ì‹¤íŒ¨");
    else { loadHistory(); refreshDashboard(); }
}

// 6. ê¸‰ì—¬ ìë™ ì—°ë™ (Salary Sync)
async function syncSalary() {
    const ym = document.getElementById("salaryMonth").value;
    if(!ym) return alert("ë…„-ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");
    if(!confirm(ym + "ì›” ê¸‰ì—¬ ë‚´ì—­ì„ íšŒê³„ì „í‘œë¡œ ê°€ì ¸ì˜¤ê² ìŠµë‹ˆê¹Œ?")) return;

    // 1) í•´ë‹¹ ì›” ê¸‰ì—¬ í•©ê³„ ì¡°íšŒ (hr_salary í…Œì´ë¸”)
    const { data: salaries } = await _supabase.from('hr_salary').select('*').eq('year_month', ym);
    
    if(!salaries || salaries.length === 0) return alert("í•´ë‹¹ ì›”ì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    
    let totalPay = 0;
    salaries.forEach(s => totalPay += Number(s.pay_total)); // ì§€ê¸‰ì´ì•¡ í•©ì‚°

    // 2) ì „í‘œ ìƒì„± (ë¹„ìš© - ê¸‰ì—¬)
    const payload = {
        date: `${ym}-25`, // 25ì¼ ì§€ê¸‰ì¼ ê°€ì •
        type: 'ë¹„ìš©',
        account_name: 'ê¸‰ì—¬',
        category: 'ì¸ê±´ë¹„',
        description: `${ym}ì›”ë¶„ ì„ì§ì› ê¸‰ì—¬ ì¼ê´„ ë“±ë¡ (${salaries.length}ëª…)`,
        amount: totalPay,
        vat: 0,
        payer: 'íšŒì‚¬',
        method: 'ê³„ì¢Œì´ì²´',
        project: 'ë³¸ì‚¬'
    };

    const { error } = await _supabase.from('acc_transactions').insert(payload);
    if(error) alert("ì—°ë™ ì‹¤íŒ¨: " + error.message);
    else { alert("ì—°ë™ ì™„ë£Œ!"); refreshDashboard(); loadHistory(); }
}

// 7. ê²°ì‚° ë³´ê³ ì„œ ìƒì„± (JS ì§‘ê³„)
async function printReport() {
    const { data } = await _supabase.from('acc_transactions').select('*');
    if(!data) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    let rev={}, exp={}, ast={}, liab={}, eq={}; // ê³„ì •ê³¼ëª©ë³„ ì§‘ê³„ìš©
    let totalRev=0, totalExp=0;

    data.forEach(r => {
        const amt = Number(r.amount);
        if(r.type==='ë§¤ì¶œ') { rev[r.account_name] = (rev[r.account_name]||0)+amt; totalRev+=amt; }
        else if(r.type==='ë¹„ìš©') { exp[r.account_name] = (exp[r.account_name]||0)+amt; totalExp+=amt; }
        else if(r.type==='ìì‚°') ast[r.account_name] = (ast[r.account_name]||0)+amt;
        // ë¶€ì±„/ìë³¸ ë¡œì§ì€ ì•½ì‹
    });

    const netIncome = totalRev - totalExp;
    const html = `
        <h2 style="text-align:center;">ì†ìµê³„ì‚°ì„œ (ì•½ì‹)</h2>
        <div style="text-align:right; margin-bottom:10px;">${new Date().toLocaleDateString()} ê¸°ì¤€</div>
        <table class="tbl">
            <tr><th colspan="2">ê³¼ëª©</th><th>ê¸ˆì•¡</th></tr>
            <tr style="background:#e8f5e9;"><td colspan="2"><b>I. ë§¤ ì¶œ ì•¡</b></td><td class="amt"><b>${totalRev.toLocaleString()}</b></td></tr>
            ${Object.keys(rev).map(k=>`<tr><td></td><td>${k}</td><td class="amt">${rev[k].toLocaleString()}</td></tr>`).join('')}
            
            <tr style="background:#ffebee;"><td colspan="2"><b>II. ì˜ì—…ë¹„ìš©</b></td><td class="amt"><b>${totalExp.toLocaleString()}</b></td></tr>
            ${Object.keys(exp).map(k=>`<tr><td></td><td>${k}</td><td class="amt">${exp[k].toLocaleString()}</td></tr>`).join('')}
            
            <tr style="background:#fff3cd; border-top:2px solid #333;"><td colspan="2"><b>III. ë‹¹ê¸°ìˆœì´ìµ</b></td><td class="amt"><b>${netIncome.toLocaleString()}</b></td></tr>
        </table>
    `;
    
    document.getElementById("reportContent").innerHTML = html;
    reportModal.show();
}

function realPrint() {
    const content = document.getElementById("reportContent").innerHTML;
    const win = window.open("", "", "width=900,height=1000");
    win.document.write(`<html><head><title>ê²°ì‚°ë³´ê³ ì„œ</title><style>body{font-family:sans-serif;padding:30px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ccc;padding:8px;} th{background:#f8f9fa;} .amt{text-align:right;}</style></head><body>${content}</body></html>`);
    win.document.close();
    win.print();
}

// ê¸°íƒ€ UI í—¬í¼
function toggleSettleMode() {
    const mode = document.querySelector('input[name="settleMode"]:checked').value;
    const div = document.getElementById("payerInputDiv");
    if(mode) { div.style.display="block"; document.getElementById("modeBadge").className = "badge bg-primary"; document.getElementById("modeBadge").innerText = "íŠ¹ìˆ˜"; }
    else { div.style.display="none"; document.getElementById("modeBadge").className = "badge bg-secondary"; document.getElementById("modeBadge").innerText = "ì¼ë°˜"; }
}
function toggleCardSelect() {
    const chk = document.getElementById("payMethod").checked;
    document.getElementById("cardSelect").classList.toggle("hidden", !chk);
}
function handleTypeChange() {
    document.getElementById("displayAccount").value = "";
    document.getElementById("hiddenItem").value = "";
    document.getElementById("dynamicArea").innerHTML = "";
}
function openAddModal() { addModal.show(); }
async function confAdd() {
    const name = document.getElementById("addName").value;
    const cat = document.getElementById("addMediumInput").value;
    if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
    const type = document.querySelector('input[name="inputType"]:checked').value;
    
    const { error } = await _supabase.from('acc_accounts').insert({type, category:cat, name});
    if(error) alert("ì¶”ê°€ ì‹¤íŒ¨");
    else { alert("ì¶”ê°€ë¨"); addModal.hide(); loadMasterData(); }
}
function openInfoModal() { infoModal.show(); }
async function saveInfo() { 
    // ë‚˜ì¤‘ì— ref_org_info í…Œì´ë¸” ë§Œë“¤ì–´ì„œ ì €ì¥ êµ¬í˜„ 
    alert("ì„¤ì • ì €ì¥ ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤."); infoModal.hide(); 
}
</script>
</body>
</html>
