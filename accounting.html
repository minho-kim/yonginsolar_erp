<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>íšŒê³„ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif; }
    .main-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px; }
    
    .stat-card { flex: 1; padding: 15px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .bg-rev { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-exp { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-ast { background: linear-gradient(135deg, #3498db, #2980b9); }
    
    .sub-card { flex: 1; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #eee; background-color: #fff; }
    .text-vat { color: #d63384; font-weight: bold; } 
    .text-cash { color: #0d6efd; font-weight: bold; }
    
    .btn-report { width: 100%; margin-bottom: 20px; font-weight: bold; border-radius: 10px; }
    .readonly-input { background-color: #f8f9fa; cursor: pointer; }
    
    /* ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
    #reportContent { font-family: "Malgun Gothic", serif; font-size: 13px; }
    .tbl { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .tbl th, .tbl td { border: 1px solid #ddd; padding: 6px; }
    .tbl th { background: #f8f9fa; text-align: center; font-weight: bold; }
    .amt { text-align: right; }
    
    .vat-wrapper { display: flex; align-items: center; justify-content: flex-end; margin-bottom: 5px; }
    .search-list-item:hover { background-color: #e9ecef; cursor: pointer; }
    .special-box { background-color: #f1f3f5; border-radius: 8px; padding: 10px; margin-bottom: 15px; border-left: 4px solid #6c757d; }
    
    .hidden { display: none !important; }
    .ime-kr { ime-mode: active; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">ğŸ“’ íšŒê³„ ê´€ë¦¬</h4>
    <div>
      <button class="btn btn-outline-secondary btn-sm me-1" onclick="openInfoModal()">âš™ï¸ ì„¤ì •</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2">
    <div class="stat-card bg-rev"><div>ë§¤ì¶œ</div><div class="fw-bold" id="valRev">0</div></div>
    <div class="stat-card bg-exp"><div>ë¹„ìš©</div><div class="fw-bold" id="valExp">0</div></div>
    <div class="stat-card bg-ast"><div>ìì‚°</div><div class="fw-bold" id="valAst">0</div></div>
  </div>
  <div class="d-flex gap-2 mb-4">
    <div class="sub-card"><div>ğŸ’° í†µì¥ ì”ê³  (ì¶”ì •)</div><div class="text-cash" id="valCash">0</div></div>
    <div class="sub-card"><div>ğŸ§¾ ë¶€ê°€ì„¸ ì˜ˆìƒ</div><div class="text-vat" id="valVat">0</div></div>
  </div>
  <button class="btn btn-outline-dark btn-report" type="button" onclick="printReport()">ğŸ–¨ï¸ ê²°ì‚° ë³´ê³ ì„œ ìƒì„±</button>

  <ul class="nav nav-tabs mb-4" id="accTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabForm">ğŸ“ ì „í‘œì…ë ¥</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSync">ğŸ”„ ìë™ì—°ë™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistory" onclick="loadHistory()">ğŸ•’ ìµœê·¼ì „í‘œ</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tabForm">
      <form id="erpForm" onsubmit="handleFormSubmit(event)">
        <div class="row mb-3">
          <div class="col-6"><label class="small text-muted">ë‚ ì§œ</label><input type="date" class="form-control" id="dateField" required></div>
          <div class="col-6">
            <label class="small text-muted">í”„ë¡œì íŠ¸</label>
            <select class="form-select" id="projectSelect">
              <option value="ë³¸ì‚¬">ë³¸ì‚¬</option><option value="1í˜¸ê¸°">1í˜¸ê¸° ë°œì „ì†Œ</option><option value="2í˜¸ê¸°">2í˜¸ê¸° ë°œì „ì†Œ</option>
            </select>
          </div>
        </div>

        <div class="mb-3 p-2 border rounded bg-light">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="small text-muted fw-bold">ê±°ë˜ êµ¬ë¶„</label>
            <span class="badge bg-secondary" id="modeBadge">ì¼ë°˜</span>
          </div>
          <div class="d-flex gap-2">
             <input type="radio" class="btn-check" name="settleMode" id="smNorm" value="" checked onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-secondary flex-fill" for="smNorm">ì¼ë°˜ê±°ë˜</label>
             <input type="radio" class="btn-check" name="settleMode" id="smPre" value="pre_expense" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-primary flex-fill" for="smPre">ì„¤ë¦½ì „/ê°œì¸</label>
             <input type="radio" class="btn-check" name="settleMode" id="smReim" value="reimburse" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-danger flex-fill" for="smReim">ì •ì‚°ì§€ê¸‰</label>
          </div>
          <div id="payerInputDiv" class="mt-2 hidden">
            <div class="input-group input-group-sm">
              <span class="input-group-text fw-bold" id="payerLabel">ì´ë¦„</span>
              <input type="text" class="form-control ime-kr" id="payerName" placeholder="í™ê¸¸ë™">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <div class="btn-group w-100">
            <input type="radio" class="btn-check" name="inputType" id="t1" value="ë§¤ì¶œ" onchange="handleTypeChange()"><label class="btn btn-outline-success" for="t1">ë§¤ì¶œ</label>
            <input type="radio" class="btn-check" name="inputType" id="t2" value="ë¹„ìš©" checked onchange="handleTypeChange()"><label class="btn btn-outline-danger" for="t2">ë¹„ìš©</label>
            <input type="radio" class="btn-check" name="inputType" id="t3" value="ìì‚°" onchange="handleTypeChange()"><label class="btn btn-outline-primary" for="t3">ìì‚°</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="small text-muted">ê³„ì •ê³¼ëª©</label>
          <div class="input-group">
            <input type="text" class="form-control readonly-input ime-kr" id="displayAccount" placeholder="í´ë¦­í•˜ì—¬ ê²€ìƒ‰" readonly onclick="openSelModal()">
            <button class="btn btn-secondary" type="button" onclick="openSelModal()">ğŸ”</button>
            <button class="btn btn-outline-secondary" type="button" onclick="openAddModal()">â•</button>
          </div>
          <input type="hidden" id="hiddenItem"><input type="hidden" id="hiddenStandard"><input type="hidden" id="specialMode">
        </div>

        <div id="dynamicArea"></div>

        <div class="mb-3"><label class="small text-muted">ì ìš”</label><input type="text" class="form-control ime-kr" id="inputDesc" required></div>
        <div class="mb-2"><label class="small text-muted">ê¸ˆì•¡ (ê³µê¸‰ê°€+ì„¸ì•¡)</label><input type="number" class="form-control form-control-lg" id="inputAmount" placeholder="0" required min="0"></div>
        
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center" id="cardOptionDiv" style="flex:1;">
             <div class="form-check form-switch me-2"><input class="form-check-input" type="checkbox" id="payMethod" value="card" onchange="toggleCardSelect()"><label class="form-check-label small" for="payMethod">ğŸ’³ ì¹´ë“œ</label></div>
             <select class="form-select form-select-sm hidden" id="cardSelect" style="max-width: 150px;"><option value="">ì„ íƒ</option></select>
           </div>
           <div class="vat-wrapper"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="vatCheck" checked><label class="form-check-label small" for="vatCheck">ë¶€ê°€ì„¸í¬í•¨</label></div></div>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm mt-3" id="submitBtn">ì €ì¥í•˜ê¸°</button>
      </form>
    </div>

    <div class="tab-pane fade" id="tabSync">
      <div class="card p-3 mb-2 border" style="border-left: 5px solid #0dcaf0;">
         <div class="d-flex justify-content-between align-items-center">
           <div><h6 class="fw-bold mb-1">ğŸ’¼ ê¸‰ì—¬ ëŒ€ì¥ ì—°ë™</h6><small class="text-muted">HR ê¸‰ì—¬ ë‚´ì—­ â†’ íšŒê³„ ì „í‘œ</small></div>
           <div class="d-flex align-items-center gap-2">
               <input type="month" id="salaryMonth" class="form-control form-control-sm" style="width: 120px;">
               <button class="btn btn-info btn-sm text-white" onclick="syncSalary()">ì‹¤í–‰</button>
           </div>
         </div>
      </div>
      <div class="card p-3 mb-2 border" style="border-left: 5px solid #ffc107;">
         <div class="d-flex justify-content-between align-items-center">
           <div><h6 class="fw-bold mb-1">ğŸ“ ì „ìê²°ì¬ ì—°ë™</h6><small class="text-muted">ì™„ë£Œëœ ì§€ì¶œê²°ì˜ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</small></div>
           <button class="btn btn-warning btn-sm" onclick="syncApprovals()">ì‹¤í–‰</button>
         </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tabHistory">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold m-0">ìµœê·¼ ì „í‘œ 10ê±´</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="loadHistory()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="historyList" class="list-group"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="selectModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header p-2"><h6 class="m-0">ê³„ì •ê³¼ëª© ê²€ìƒ‰</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-2"><input type="text" class="form-control mb-2 ime-kr" id="accountSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" onkeyup="filterAccounts()"><div class="list-group" id="accountSearchResult" style="height:300px;overflow-y:auto;"></div></div></div></div></div>
<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">í•­ëª© ì¶”ê°€</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" class="form-control mb-2" id="addMediumInput" placeholder="ì¤‘ë¶„ë¥˜ (ì˜ˆ: ìš´ì˜ë¹„)"><input type="text" class="form-control" id="addName" placeholder="í•­ëª©ëª… (ì˜ˆ: íšŒì‹ë¹„)"></div><div class="modal-footer"><button class="btn btn-primary" onclick="confAdd()">ì¶”ê°€</button></div></div></div></div>
<div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ğŸ“„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="reportContent"></div><div class="modal-footer"><button class="btn btn-primary" onclick="realPrint()">ğŸ–¨ï¸ ì¸ì‡„</button></div></div></div></div>
<div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">âš™ï¸ ì„¤ì •</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="infoForm"><div class="mb-2"><label>ì¡°í•©ëª…</label><input type="text" class="form-control" id="orgName"></div><div class="mb-3"><label>ì„¤ë¦½ì¼</label><input type="date" class="form-control" id="estDate"></div></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveInfo()">ì €ì¥</button></div></div></div></div>

<script>
// [ìˆ˜í¼ë² ì´ìŠ¤ ì—°ê²°]
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let mData=[], cardData=[]; 
let selectModal, reportModal, addModal, infoModal;
let myInfo = null;

window.onload = async function() {
    selectModal = new bootstrap.Modal(document.getElementById('selectModal'));
    reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    addModal = new bootstrap.Modal(document.getElementById('addModal'));
    infoModal = new bootstrap.Modal(document.getElementById('infoModal'));

    const stored = localStorage.getItem('erp_user');
    if(stored) myInfo = JSON.parse(stored);

    document.getElementById('dateField').valueAsDate = new Date();
    document.getElementById('salaryMonth').value = new Date().toISOString().slice(0, 7);

    // ê¸°ì´ˆ ë°ì´í„° ë¡œë“œ (êµ­ì¥ë‹˜ í…Œì´ë¸”ëª… ë°˜ì˜)
    await loadMasterData();
    await loadCards();
    await refreshDashboard();
};

// 1. ê¸°ì´ˆ ë°ì´í„° (ac_master, ref_cards)
async function loadMasterData() {
    // [ìˆ˜ì •] í•„ë“œëª…: Type, Standard, Item, Tax_Free, SpecialType
    const { data } = await _supabase.from('ac_master').select('*').order('Type').order('Standard').order('Item');
    if(data) mData = data;
}
async function loadCards() {
    // [ìˆ˜ì •] í•„ë“œëª…: card_alias
    const { data } = await _supabase.from('ref_cards').select('*');
    if(data) {
        cardData = data;
        const sel = document.getElementById("cardSelect");
        sel.innerHTML = "<option value=''>ì„ íƒ</option>";
        cardData.forEach(c => sel.add(new Option(c.card_alias, c.card_alias))); 
    }
}

// 2. ëŒ€ì‹œë³´ë“œ (ac_journal: Debit/Credit êµ¬ì¡° ë°˜ì˜)
// 2. ëŒ€ì‹œë³´ë“œ (ìˆ˜ì •ë¨: ì°¨ë³€/ëŒ€ë³€ ë…¼ë¦¬ì— ë”°ë¥¸ ì •í™•í•œ ê³„ì‚°)
async function refreshDashboard() {
    // 1. ì „í‘œ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
    const { data } = await _supabase.from('ac_journal').select('*');
    
    let rev = 0; // ë§¤ì¶œ (ìˆ˜ìµ)
    let exp = 0; // ë¹„ìš©
    let ast = 0; // ìì‚° (í˜„ì¬ í†µì¥+í˜„ê¸ˆ+ë¯¸ìˆ˜ê¸ˆ ë“± ì´í•©)
    let liab = 0; // ë¶€ì±„
    let cap = 0; // ìë³¸ (ì¶œìê¸ˆ ë“±)

    if (data) {
        data.forEach(r => {
            // ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜ (ì—†ìœ¼ë©´ 0)
            const debit = Number(r.Debit || 0);  // ì°¨ë³€
            const credit = Number(r.Credit || 0); // ëŒ€ë³€

            // íšŒê³„ ë“±ì‹ì— ë”°ë¥¸ ì§‘ê³„
            if (r.Type === 'ë§¤ì¶œ') {
                rev += credit; // ìˆ˜ìµì€ ëŒ€ë³€ì—ì„œ ë°œìƒ
            } 
            else if (r.Type === 'ë¹„ìš©') {
                exp += debit; // ë¹„ìš©ì€ ì°¨ë³€ì—ì„œ ë°œìƒ
            } 
            else if (r.Type === 'ìì‚°') {
                ast += (debit - credit); // ìì‚° = ì°¨ë³€(ì¦ê°€) - ëŒ€ë³€(ê°ì†Œ)
            }
            else if (r.Type === 'ë¶€ì±„') {
                liab += (credit - debit); // ë¶€ì±„ = ëŒ€ë³€(ì¦ê°€) - ì°¨ë³€(ê°ì†Œ)
            }
            else if (r.Type === 'ìë³¸') {
                cap += (credit - debit); // ìë³¸ = ëŒ€ë³€(ì¦ê°€) - ì°¨ë³€(ê°ì†Œ)
            }
        });
    }

    // í™”ë©´ í‘œì‹œ
    document.getElementById("valRev").innerText = rev.toLocaleString();
    document.getElementById("valExp").innerText = exp.toLocaleString();
    
    // [ìˆ˜ì •] ë‹¨ìˆœ ì´ì•¡ì´ ì•„ë‹ˆë¼ 'í˜„ì¬ ì”ì•¡' ê°œë…ìœ¼ë¡œ í‘œì‹œ
    document.getElementById("valAst").innerText = ast.toLocaleString(); 

    // ë¶€ê°€ì„¸ ì¶”ì • (ë§¤ì¶œì˜ 10% - ë¹„ìš©ì˜ 10% ë‹¨ìˆœ ì¶”ì‚°)
    // ì •í™•í•˜ë ¤ë©´ ì „í‘œë§ˆë‹¤ vat ì»¬ëŸ¼ì„ í•©ì‚°í•´ì•¼ í•˜ì§€ë§Œ ì¼ë‹¨ ì•½ì‹ ìœ ì§€
    document.getElementById("valVat").innerText = Math.round((rev - exp) * 0.1).toLocaleString();

    // [í•µì‹¬ ìˆ˜ì •] í†µì¥ ì”ê³ (ì¶”ì •) -> ë‹¹ê¸° ìˆœì´ìµ(ì†ì‹¤)ë¡œ ëª…ì¹­ ë³€ê²½ ë˜ëŠ” ì‹¤ì œ í˜„ê¸ˆì„± ìì‚° í‘œì‹œ
    // ì—¬ê¸°ì„œëŠ” êµ­ì¥ë‹˜ì´ í—·ê°ˆë ¤ í•˜ì…¨ë˜ 'ë§ˆì´ë„ˆìŠ¤'ì˜ ì •ì²´ì¸ 'ìˆœì´ìµ'ì„ ë³´ì—¬ì£¼ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤.
    const netIncome = rev - exp;
    const cashLabel = document.querySelector("#valCash").previousElementSibling;
    const cashValue = document.getElementById("valCash");

    if (netIncome >= 0) {
        cashLabel.innerHTML = "ğŸ“ˆ ë‹¹ê¸° ìˆœì´ìµ";
        cashValue.className = "text-primary fw-bold"; // íŒŒë€ìƒ‰
    } else {
        cashLabel.innerHTML = "ğŸ“‰ ë‹¹ê¸° ìˆœì†ì‹¤"; // ì ìì„ì„ ëª…ì‹œ
        cashValue.className = "text-danger fw-bold"; // ë¹¨ê°„ìƒ‰
    }
    cashValue.innerText = netIncome.toLocaleString();
}

// 3. ì „í‘œ ì €ì¥ (ac_journal)
async function handleFormSubmit(e) {
    e.preventDefault();
    if(!document.getElementById("hiddenItem").value) return alert("ê³„ì •ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    
    const type = document.querySelector('input[name="inputType"]:checked').value;
    const totalAmt = Number(document.getElementById("inputAmount").value);
    
    // ì°¨ë³€/ëŒ€ë³€ ë¡œì§ (ê°„ì†Œí™”: ë¹„ìš©/ìì‚°ì¦ê°€=Debit, ë§¤ì¶œ/ë¶€ì±„ì¦ê°€=Credit)
    let debit = 0, credit = 0;
    if (type === 'ë¹„ìš©' || type === 'ìì‚°') debit = totalAmt;
    else credit = totalAmt; // ë§¤ì¶œ, ë¶€ì±„, ìë³¸

    const payload = {
        Date: document.getElementById("dateField").value,
        Type: type,
        Account: document.getElementById("hiddenItem").value,
        Description: document.getElementById("inputDesc").value,
        Debit: debit,
        Credit: credit,
        Project: document.getElementById("projectSelect").value,
        Operator: myInfo ? myInfo.emp_name : "unknown" // ì‘ì„±ì
    };

    const { error } = await _supabase.from('ac_journal').insert(payload);
    if(error) alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
    else {
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById("erpForm").reset();
        document.getElementById("smNorm").checked = true;
        refreshDashboard();
    }
}

// 4. ìµœê·¼ ì „í‘œ (ac_journal)
async function loadHistory() {
    const el = document.getElementById("historyList");
    el.innerHTML = "ë¡œë”© ì¤‘...";
    // [ìˆ˜ì •] Trans_IDëŠ” ìë™ìƒì„± ì•ˆë ìˆ˜ë„ ìˆìœ¼ë‹ˆ created_at ê¸°ì¤€ ì •ë ¬ ì¶”ì²œ
    const { data } = await _supabase.from('ac_journal').select('*').order('Date', {ascending:false}).limit(10);
    
    el.innerHTML = "";
    if(!data || data.length === 0) { el.innerHTML = "<div class='text-center p-3 text-muted'>ë‚´ì—­ ì—†ìŒ</div>"; return; }
    
    data.forEach(item => {
        const amt = Number(item.Debit || 0) + Number(item.Credit || 0);
        const div = document.createElement("div");
        div.className = "list-group-item d-flex justify-content-between align-items-center";
        div.innerHTML = `
            <div><span class="badge bg-secondary me-1">${item.Type}</span><strong>${item.Account}</strong>
            <small class="text-muted"> | ${item.Description}</small></div>
            <div class="text-end fw-bold">${amt.toLocaleString()}
            <button class="btn btn-outline-danger btn-sm ms-2" onclick="deleteTx('${item.Trans_ID || item.id}')">x</button></div>
        `; // Trans_IDê°€ ì—†ìœ¼ë©´ id(int8) ì‚¬ìš©
        el.appendChild(div);
    });
}
async function deleteTx(id) {
    if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        // id ì»¬ëŸ¼ì´ int8ì´ë¼ë©´ ìˆ«ìì—¬ì•¼ í•¨
        await _supabase.from('ac_journal').delete().eq('Trans_ID', id); // í˜¹ì€ 'id'
        loadHistory(); refreshDashboard();
    }
}

// 5. ì—°ë™ ê¸°ëŠ¥
async function syncSalary() {
    const ym = document.getElementById("salaryMonth").value;
    if(!ym) return alert("ë…„-ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");
    if(!confirm(ym + "ì›” ê¸‰ì—¬ë¥¼ ì—°ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const { data: salaries } = await _supabase.from('hr_salary').select('*').eq('year_month', ym);
    if(!salaries || salaries.length===0) return alert("ë°ì´í„° ì—†ìŒ");

    let total = 0;
    salaries.forEach(s => total += Number(s.pay_total));

    // [ìˆ˜ì •] ac_journal êµ¬ì¡°ì— ë§ê²Œ Insert
    await _supabase.from('ac_journal').insert({
        Date: `${ym}-25`, Type: 'ë¹„ìš©', Account: 'ê¸‰ì—¬', 
        Description: `${ym}ì›” ê¸‰ì—¬ (${salaries.length}ëª…)`, 
        Debit: total, Credit: 0,
        Project: 'ë³¸ì‚¬', Operator: 'System'
    });
    alert("ì™„ë£Œ"); refreshDashboard();
}

async function syncApprovals() {
    const { data: approvals } = await _supabase.from('ac_approval')
        .select('*')
        .eq('status', 'ì™„ë£Œ') 
        .like('doc_type', '%ì§€ì¶œ%');

    if(!approvals || approvals.length === 0) return alert("ì—°ë™í•  ìŠ¹ì¸ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.");
    if(!confirm(`ì´ ${approvals.length}ê±´ì˜ ìŠ¹ì¸ëœ ì§€ì¶œì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    let count = 0;
    for (const doc of approvals) {
        const { error } = await _supabase.from('ac_journal').insert({
            Date: new Date().toISOString().slice(0,10),
            Type: 'ë¹„ìš©',
            Account: 'ë¯¸ë¶„ë¥˜ë¹„ìš©', 
            Description: `[ì „ìê²°ì¬] ${doc.title}`,
            Debit: doc.amount, Credit: 0,
            Project: 'ë³¸ì‚¬', Operator: doc.drafter_name
        });
        if(!error) count++;
    }
    alert(`${count}ê±´ ì—°ë™ ì™„ë£Œ`);
    refreshDashboard(); loadHistory();
}

// 6. ì„¤ì •
async function openInfoModal() {
    const { data } = await _supabase.from('ref_company_info').select('*');
    const map = {};
    if(data) data.forEach(i => map[i.key] = i.value);
    document.getElementById("orgName").value = map['orgName'] || "";
    document.getElementById("estDate").value = map['estDate'] || "";
    infoModal.show();
}
async function saveInfo() {
    const updates = [
        { key: 'orgName', value: document.getElementById("orgName").value },
        { key: 'estDate', value: document.getElementById("estDate").value }
    ];
    await _supabase.from('ref_company_info').upsert(updates);
    alert("ì €ì¥ë¨"); infoModal.hide();
}

// 7. ë¦¬í¬íŠ¸
async function printReport() {
    const { data } = await _supabase.from('ac_journal').select('*');
    let rev={}, exp={}, totalRev=0, totalExp=0;
    data.forEach(r => {
        const amt = Number(r.Debit || 0) + Number(r.Credit || 0);
        if(r.Type==='ë§¤ì¶œ') { rev[r.Account] = (rev[r.Account]||0)+amt; totalRev+=amt; }
        else if(r.Type==='ë¹„ìš©') { exp[r.Account] = (exp[r.Account]||0)+amt; totalExp+=amt; }
    });
    
    const html = `
        <h3 class="text-center">ì†ìµê³„ì‚°ì„œ</h3>
        <table class="tbl">
            <tr style="background:#eee"><td>ë§¤ì¶œ</td><td class="amt">${totalRev.toLocaleString()}</td></tr>
            ${Object.keys(rev).map(k=>`<tr><td>${k}</td><td class="amt">${rev[k].toLocaleString()}</td></tr>`).join('')}
            <tr style="background:#eee"><td>ë¹„ìš©</td><td class="amt">${totalExp.toLocaleString()}</td></tr>
            ${Object.keys(exp).map(k=>`<tr><td>${k}</td><td class="amt">${exp[k].toLocaleString()}</td></tr>`).join('')}
            <tr style="border-top:2px solid #000"><td><b>ì´ìµ</b></td><td class="amt"><b>${(totalRev-totalExp).toLocaleString()}</b></td></tr>
        </table>
    `;
    document.getElementById("reportContent").innerHTML = html;
    reportModal.show();
}
function realPrint() {
    const w = window.open();
    w.document.write(document.getElementById("reportContent").innerHTML);
    w.print(); w.close();
}

// UI Helpers
function toggleSettleMode() {
    const mode = document.querySelector('input[name="settleMode"]:checked').value;
    const div = document.getElementById("payerInputDiv");
    if(mode) { div.classList.remove('hidden'); document.getElementById("modeBadge").className="badge bg-primary"; document.getElementById("modeBadge").innerText="íŠ¹ìˆ˜"; }
    else { div.classList.add('hidden'); document.getElementById("modeBadge").className="badge bg-secondary"; document.getElementById("modeBadge").innerText="ì¼ë°˜"; }
}
function toggleCardSelect() {
    const chk = document.getElementById("payMethod").checked;
    document.getElementById("cardSelect").classList.toggle("hidden", !chk);
}
function handleTypeChange() {
    document.getElementById("displayAccount").value="";
    document.getElementById("hiddenItem").value="";
    document.getElementById("dynamicArea").innerHTML="";
}
function openSelModal() { document.getElementById("accountSearchInput").value=""; filterAccounts(); selectModal.show(); }
function filterAccounts() {
    const k = document.getElementById("accountSearchInput").value.trim();
    const t = document.querySelector('input[name="inputType"]:checked').value;
    const list = document.getElementById("accountSearchResult");
    list.innerHTML="";
    const filtered = mData.filter(i => {
        // [ìˆ˜ì •] í•„ë“œëª…: Type, Item, Standard
        const typeMatch = (t==='ìì‚°') ? ['ìì‚°','ë¶€ì±„','ìë³¸'].includes(i.Type) : (i.Type===t);
        return typeMatch && (i.Item.includes(k) || (i.Standard||"").includes(k));
    });
    filtered.forEach(acc => {
        const d = document.createElement("div");
        d.className = "list-group-item list-group-item-action search-list-item";
        d.innerHTML = `<strong>${acc.Item}</strong> <small>(${acc.Standard})</small>`;
        d.onclick = () => {
            document.getElementById("displayAccount").value = acc.Item;
            document.getElementById("hiddenItem").value = acc.Item;
            document.getElementById("hiddenStandard").value = acc.Standard;
            updateDynamicUI(acc);
            selectModal.hide();
        };
        list.appendChild(d);
    });
}
function updateDynamicUI(acc) {
    const area = document.getElementById("dynamicArea");
    const special = document.getElementById("specialMode");
    const vat = document.getElementById("vatCheck");
    area.innerHTML=""; special.value="";
    
    // [ìˆ˜ì •] í•„ë“œëª…: Tax_Free (boolean ì•„ë‹ ìˆ˜ ìˆìŒ, ì²´í¬ í•„ìš”)
    if(acc.Tax_Free == 'TRUE' || acc.Tax_Free === true) { vat.checked=false; vat.disabled=true; } 
    else { vat.disabled=false; vat.checked=true; }
    
    // [ìˆ˜ì •] í•„ë“œëª…: SpecialType
    if(acc.SpecialType==='salary') {
        special.value="salary";
        area.innerHTML=`<div class="special-box"><small class="fw-bold text-success">ê¸‰ì—¬ ì…ë ¥ ëª¨ë“œ</small></div>`;
        vat.checked=false;
    }
}
function openAddModal() { addModal.show(); }
async function confAdd() {
    const name = document.getElementById("addName").value;
    const cat = document.getElementById("addMediumInput").value;
    const type = document.querySelector('input[name="inputType"]:checked').value;
    if(!name) return alert("ì…ë ¥í•˜ì„¸ìš”");
    // [ìˆ˜ì •] í•„ë“œëª…: Type, Standard, Item
    await _supabase.from('ac_master').insert({Type:type, Standard:cat, Item:name});
    alert("ì¶”ê°€ë¨"); addModal.hide(); loadMasterData();
}
</script>
</body>
</html>
